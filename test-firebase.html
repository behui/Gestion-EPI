<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase Connection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üî• Test de Connexion Firebase</h1>
    
    <div class="test-box">
        <h2>√âtat de la connexion</h2>
        <div id="status">‚è≥ Test en cours...</div>
    </div>

    <div class="test-box">
        <h2>Actions de test</h2>
        <button onclick="testWrite()">üìù Test √âcriture</button>
        <button onclick="testRead()">üìñ Test Lecture</button>
        <button onclick="testRealtime()">üîÑ Test Temps R√©el</button>
    </div>

    <div class="test-box">
        <h2>Console de logs</h2>
        <pre id="logs"></pre>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDMPBik5vpX8qOYWuhPzpJZoOLjE20pl6g",
            authDomain: "gestion-epi-4387a.firebaseapp.com",
            projectId: "gestion-epi-4387a",
            storageBucket: "gestion-epi-4387a.firebasestorage.app",
            messagingSenderId: "974706767408",
            appId: "1:974706767408:web:fde01e52a3a986d6da9ff5",
            measurementId: "G-PKNXH32P0Z"
        };

        let app, db;
        let logDiv = null;
        let statusDiv = null;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚è≥';
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            statusDiv.innerHTML = `<span class="${className}">${icon} ${message}</span>`;
        }

        async function initFirebase() {
            try {
                addLog('üî• Initialisation de Firebase...', 'info');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // Rendre accessibles globalement
                window.firebaseApp = app;
                window.firebaseDB = db;
                window.firestoreDoc = doc;
                window.firestoreSetDoc = setDoc;
                window.firestoreGetDoc = getDoc;
                window.firestoreOnSnapshot = onSnapshot;
                
                addLog('‚úÖ Firebase initialis√© avec succ√®s', 'success');
                addLog(`üìç Projet: ${firebaseConfig.projectId}`, 'info');
                updateStatus('Firebase connect√© et pr√™t', 'success');
                
                // Test de lecture automatique
                await testRead();
                
            } catch (error) {
                addLog(`‚ùå Erreur d'initialisation: ${error.message}`, 'error');
                addLog(`D√©tails: ${error.stack}`, 'error');
                updateStatus('Erreur de connexion Firebase', 'error');
            }
        }

        window.testWrite = async function() {
            try {
                addLog('üìù Test d\'√©criture dans Firebase...', 'info');
                
                const testData = {
                    test: true,
                    message: 'Test √©criture',
                    timestamp: new Date().toISOString(),
                    number: Math.random()
                };
                
                const docRef = doc(db, 'test', 'connection');
                await setDoc(docRef, testData);
                
                addLog('‚úÖ √âcriture r√©ussie!', 'success');
                addLog(`Donn√©es √©crites: ${JSON.stringify(testData, null, 2)}`, 'info');
                updateStatus('√âcriture Firebase OK', 'success');
                
            } catch (error) {
                addLog(`‚ùå Erreur d'√©criture: ${error.message}`, 'error');
                addLog(`Code: ${error.code}`, 'error');
                addLog(`D√©tails: ${error.stack}`, 'error');
                updateStatus('√âchec √©criture Firebase', 'error');
            }
        };

        window.testRead = async function() {
            try {
                addLog('üìñ Test de lecture depuis Firebase...', 'info');
                
                const docRef = doc(db, 'casiers', 'data');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    addLog('‚úÖ Lecture r√©ussie!', 'success');
                    addLog(`Document existe: ${docSnap.id}`, 'info');
                    
                    if (data.lockers) {
                        addLog(`Nombre de casiers: ${data.lockers.length}`, 'info');
                        
                        // Compter les statuts
                        const stats = {
                            LIBRE: 0,
                            'EN ATTENTE': 0,
                            OCCUP√â: 0,
                            INACTIF: 0
                        };
                        
                        data.lockers.forEach(locker => {
                            stats[locker.statut] = (stats[locker.statut] || 0) + 1;
                        });
                        
                        addLog(`Stats - Libres: ${stats.LIBRE}, En attente: ${stats['EN ATTENTE']}, Occup√©s: ${stats.OCCUP√â}, Inactifs: ${stats.INACTIF}`, 'info');
                    }
                    
                    if (data.lastUpdate) {
                        addLog(`Derni√®re mise √† jour: ${new Date(data.lastUpdate).toLocaleString()}`, 'info');
                    }
                    
                    updateStatus('Lecture Firebase OK', 'success');
                } else {
                    addLog('‚ö†Ô∏è Document "casiers/data" n\'existe pas encore', 'error');
                    addLog('Cr√©ez des donn√©es en utilisant l\'application principale', 'info');
                    updateStatus('Aucune donn√©e trouv√©e', 'error');
                }
                
            } catch (error) {
                addLog(`‚ùå Erreur de lecture: ${error.message}`, 'error');
                addLog(`Code: ${error.code}`, 'error');
                addLog(`D√©tails: ${error.stack}`, 'error');
                updateStatus('√âchec lecture Firebase', 'error');
            }
        };

        window.testRealtime = function() {
            try {
                addLog('üîÑ Activation de la synchronisation temps r√©el...', 'info');
                
                const docRef = doc(db, 'casiers', 'data');
                
                const unsubscribe = onSnapshot(docRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        addLog('üîî Changement d√©tect√© en temps r√©el!', 'success');
                        addLog(`Timestamp: ${data.lastUpdate || 'N/A'}`, 'info');
                        
                        if (data.lockers) {
                            addLog(`Nombre de casiers: ${data.lockers.length}`, 'info');
                        }
                    } else {
                        addLog('‚ö†Ô∏è Document supprim√© ou inexistant', 'error');
                    }
                }, (error) => {
                    addLog(`‚ùå Erreur sync temps r√©el: ${error.message}`, 'error');
                    addLog(`Code: ${error.code}`, 'error');
                });
                
                addLog('‚úÖ Listener temps r√©el activ√© (modifiez les donn√©es dans l\'app principale pour voir les changements)', 'success');
                updateStatus('Synchronisation temps r√©el active', 'success');
                
                // Nettoyer apr√®s 30 secondes
                setTimeout(() => {
                    unsubscribe();
                    addLog('üõë Listener temps r√©el d√©sactiv√©', 'info');
                }, 30000);
                
            } catch (error) {
                addLog(`‚ùå Erreur sync temps r√©el: ${error.message}`, 'error');
                addLog(`D√©tails: ${error.stack}`, 'error');
                updateStatus('√âchec sync temps r√©el', 'error');
            }
        };

        // Initialiser au chargement
        window.addEventListener('DOMContentLoaded', () => {
            logDiv = document.getElementById('logs');
            statusDiv = document.getElementById('status');
            initFirebase();
        });
    </script>
</body>
</html>
