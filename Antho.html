<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Gestion √âquipements Ventilation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        /* ONGLETS */
        .tabs {
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            border: none;
            background: #f3f4f6;
            color: #666;
            font-size: 1em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .kpi-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .kpi-card.masques .value { color: #8b5cf6; }
        .kpi-card.tuyaux .value { color: #10b981; }
        .kpi-card.moteurs .value { color: #f59e0b; }
        .kpi-card.batteries .value { color: #ef4444; }
        .kpi-card.stock .value { color: #f59e0b; }
        .kpi-card.utilisation .value { color: #3b82f6; }
        .kpi-card.maintenance .value { color: #ef4444; }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-stock {
            background: #f59e0b;
            color: white;
            flex: 1;
        }

        .btn-stock:hover {
            background: #d97706;
        }

        .btn-utilisation {
            background: #3b82f6;
            color: white;
            flex: 1;
        }

        .btn-utilisation:hover {
            background: #2563eb;
        }

        .btn-export {
            background: #10b981;
            color: white;
            margin-right: 10px;
        }

        .btn-export:hover {
            background: #059669;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .items-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
        }

        .item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .item.stock { border-left-color: #f59e0b; }
        .item.utilisation { border-left-color: #3b82f6; }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-ref {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .item-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-stock { background: #fef3c7; color: #92400e; }
        .status-utilisation { background: #dbeafe; color: #1e40af; }

        .item-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .item-info-full {
            grid-column: 1 / -1;
        }

        .item-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85em;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-edit:hover {
            background: #2563eb;
        }

        .btn-history {
            background: #8b5cf6;
            color: white;
        }

        .btn-history:hover {
            background: #7c3aed;
        }

        .btn-service {
            background: #10b981;
            color: white;
        }

        .btn-service:hover {
            background: #059669;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .btn-close {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-close:hover {
            background: #dc2626;
        }

        .history-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .history-date {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .history-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .type-maintenance { background: #fee2e2; color: #991b1b; }
        .type-mise-en-service { background: #d1fae5; color: #065f46; }
        .type-creation { background: #e0e7ff; color: #3730a3; }

        .chart-container {
            margin-top: 20px;
            height: 300px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-auto {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
        }

        /* Modal Suppression */
        .delete-modal-content {
            text-align: center;
        }

        .delete-warning {
            background: #fee2e2;
            color: #991b1b;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #fca5a5;
        }

        .delete-warning-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .delete-info {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
            color: #333;
        }

        .delete-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-cancel {
            background: #6b7280;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
        }

        .btn-cancel:hover {
            background: #4b5563;
        }

        .btn-confirm-delete {
            background: #ef4444;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            animation: pulse 2s infinite;
        }

        .btn-confirm-delete:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .item-actions {
                flex-direction: column;
            }

            .delete-buttons {
                flex-direction: column;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Gestion √âquipements Ventilation</h1>
            <p>Masques - Tuyaux - Moteurs - Batteries</p>
        </div>

        <!-- Dashboard KPIs -->
        <div class="dashboard">
            <div class="kpi-card masques">
                <h3>üé≠ Masques</h3>
                <div class="value" id="kpi-masques">0</div>
            </div>
            <div class="kpi-card tuyaux">
                <h3>üîß Tuyaux</h3>
                <div class="value" id="kpi-tuyaux">0</div>
            </div>
            <div class="kpi-card moteurs">
                <h3>‚öôÔ∏è Moteurs</h3>
                <div class="value" id="kpi-moteurs">0</div>
            </div>
            <div class="kpi-card batteries">
                <h3>üîã Batteries</h3>
                <div class="value" id="kpi-batteries">0</div>
            </div>
            <div class="kpi-card maintenance">
                <h3>üîß Maintenances Totales</h3>
                <div class="value" id="kpi-maintenances">0</div>
            </div>
        </div>

        <!-- Boutons Export -->
        <div class="export-buttons">
            <button class="btn btn-export" onclick="exportToExcel()">üìä Export Excel (Power BI)</button>
            <button class="btn btn-export" onclick="exportAllToPDF()">üìÑ Fiche Audit PDF</button>
        </div>

        <!-- Onglets -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('masques')">
                üé≠ MASQUES
            </button>
            <button class="tab" onclick="switchTab('tuyaux')">
                üîß TUYAUX
            </button>
            <button class="tab" onclick="switchTab('moteurs')">
                ‚öôÔ∏è MOTEURS
            </button>
            <button class="tab" onclick="switchTab('batteries')">
                üîã BATTERIES
            </button>
        </div>

        <!-- CONTENU MASQUES -->
        <div class="tab-content active" id="content-masques">
            <div class="main-content">
                <div class="card">
                    <h2>üìã Liste des Masques</h2>
                    <div class="items-list" id="list-masques"></div>
                </div>

                <div class="card">
                    <h2>‚ûï Ajouter un Masque</h2>
                    <form id="form-masques">
                        <div class="form-group">
                            <label>R√©f√©rence *</label>
                            <input type="text" id="ref-masques" required placeholder="Ex: MSA-V-Gallet">
                        </div>
                        <div class="form-group">
                            <label>Num√©ro *</label>
                            <input type="text" id="num-masques" required placeholder="Ex: 001">
                        </div>
                        <div class="date-auto">
                            üìÖ Date de r√©ception : <span id="date-masques"></span>
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-stock" onclick="addItem('masques', 'stock')">üì¶ EN STOCK</button>
                            <button type="button" class="btn btn-utilisation" onclick="addItem('masques', 'utilisation')">üîµ EN UTILISATION</button>
                        </div>
                    </form>

                    <div class="chart-container">
                        <canvas id="chart-masques"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENU TUYAUX -->
        <div class="tab-content" id="content-tuyaux">
            <div class="main-content">
                <div class="card">
                    <h2>üìã Liste des Tuyaux</h2>
                    <div class="items-list" id="list-tuyaux"></div>
                </div>

                <div class="card">
                    <h2>‚ûï Ajouter un Tuyau</h2>
                    <form id="form-tuyaux">
                        <div class="form-group">
                            <label>R√©f√©rence *</label>
                            <input type="text" id="ref-tuyaux" required placeholder="Ex: TUY-FLEX-01">
                        </div>
                        <div class="form-group">
                            <label>Num√©ro *</label>
                            <input type="text" id="num-tuyaux" required placeholder="Ex: 001">
                        </div>
                        <div class="date-auto">
                            üìÖ Date de r√©ception : <span id="date-tuyaux"></span>
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-stock" onclick="addItem('tuyaux', 'stock')">üì¶ EN STOCK</button>
                            <button type="button" class="btn btn-utilisation" onclick="addItem('tuyaux', 'utilisation')">üîµ EN UTILISATION</button>
                        </div>
                    </form>

                    <div class="chart-container">
                        <canvas id="chart-tuyaux"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENU MOTEURS -->
        <div class="tab-content" id="content-moteurs">
            <div class="main-content">
                <div class="card">
                    <h2>üìã Liste des Moteurs</h2>
                    <div class="items-list" id="list-moteurs"></div>
                </div>

                <div class="card">
                    <h2>‚ûï Ajouter un Moteur</h2>
                    <form id="form-moteurs">
                        <div class="form-group">
                            <label>R√©f√©rence *</label>
                            <input type="text" id="ref-moteurs" required placeholder="Ex: MOT-V300">
                        </div>
                        <div class="form-group">
                            <label>Num√©ro *</label>
                            <input type="text" id="num-moteurs" required placeholder="Ex: 001">
                        </div>
                        <div class="date-auto">
                            üìÖ Date de r√©ception : <span id="date-moteurs"></span>
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-stock" onclick="addItem('moteurs', 'stock')">üì¶ EN STOCK</button>
                            <button type="button" class="btn btn-utilisation" onclick="addItem('moteurs', 'utilisation')">üîµ EN UTILISATION</button>
                        </div>
                    </form>

                    <div class="chart-container">
                        <canvas id="chart-moteurs"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENU BATTERIES -->
        <div class="tab-content" id="content-batteries">
            <div class="main-content">
                <div class="card">
                    <h2>üìã Liste des Batteries</h2>
                    <div class="items-list" id="list-batteries"></div>
                </div>

                <div class="card">
                    <h2>‚ûï Ajouter une Batterie</h2>
                    <form id="form-batteries">
                        <div class="form-group">
                            <label>R√©f√©rence *</label>
                            <input type="text" id="ref-batteries" required placeholder="Ex: BAT-LION-12V">
                        </div>
                        <div class="form-group">
                            <label>Num√©ro *</label>
                            <input type="text" id="num-batteries" required placeholder="Ex: 001">
                        </div>
                        <div class="date-auto">
                            üìÖ Date de r√©ception : <span id="date-batteries"></span>
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-stock" onclick="addItem('batteries', 'stock')">üì¶ EN STOCK</button>
                            <button type="button" class="btn btn-utilisation" onclick="addItem('batteries', 'utilisation')">üîµ EN UTILISATION</button>
                        </div>
                    </form>

                    <div class="chart-container">
                        <canvas id="chart-batteries"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Mise en Service -->
    <div class="modal" id="serviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîµ Mettre en Service</h2>
                <button class="btn-close" onclick="closeModal('serviceModal')">‚úñ Fermer</button>
            </div>
            <p style="margin-bottom: 20px; color: #666;">Cet √©quipement va passer de <strong style="color: #f59e0b;">Stock</strong> √† <strong style="color: #3b82f6;">Utilisation</strong> (3 ans)</p>
            <div class="form-group">
                <label>Date de Mise en Service</label>
                <input type="date" id="dateService" required>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="confirmMiseEnService()">‚úÖ Confirmer la Mise en Service</button>
        </div>
    </div>

    <!-- Modal Maintenance -->
    <div class="modal" id="maintenanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîß Ajouter une Maintenance</h2>
                <button class="btn-close" onclick="closeModal('maintenanceModal')">‚úñ Fermer</button>
            </div>
            <div class="form-group">
                <label>Date de Maintenance</label>
                <input type="date" id="dateMaintenance" required>
            </div>
            <div class="form-group">
                <label>Commentaire</label>
                <textarea id="commentaireMaintenance" rows="3" placeholder="D√©tails de la maintenance..."></textarea>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="confirmMaintenance()">üíæ Enregistrer la Maintenance</button>
        </div>
    </div>

    <!-- Modal Historique -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìú Historique</h2>
                <button class="btn-close" onclick="closeModal('historyModal')">‚úñ Fermer</button>
            </div>
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- Modal Suppression -->
    <div class="modal" id="deleteModal">
        <div class="modal-content delete-modal-content">
            <div class="delete-warning">
                <div class="delete-warning-icon">‚ö†Ô∏è</div>
                <h2 style="color: #991b1b; margin-bottom: 10px;">ATTENTION !</h2>
                <p style="font-size: 1.1em;">Vous √™tes sur le point de supprimer cet √©quipement</p>
            </div>
            
            <div class="delete-info" id="deleteInfo"></div>
            
            <p style="color: #666; margin: 20px 0;">
                <strong>Cette action est IRR√âVERSIBLE.</strong><br>
                Toutes les donn√©es et l'historique seront d√©finitivement perdus.
            </p>
            
            <div class="delete-buttons">
                <button class="btn-cancel" onclick="closeModal('deleteModal')">‚ùå ANNULER</button>
                <button class="btn-confirm-delete" onclick="confirmDelete()">üóëÔ∏è SUPPRIMER D√âFINITIVEMENT</button>
            </div>
        </div>
    </div>

    <script>
        // Base de donn√©es locale - 4 collections s√©par√©es
        let data = {
            masques: JSON.parse(localStorage.getItem('masques')) || [],
            tuyaux: JSON.parse(localStorage.getItem('tuyaux')) || [],
            moteurs: JSON.parse(localStorage.getItem('moteurs')) || [],
            batteries: JSON.parse(localStorage.getItem('batteries')) || []
        };

        let charts = {
            masques: null,
            tuyaux: null,
            moteurs: null,
            batteries: null
        };

        let currentTab = 'masques';
        let currentItemId = null;
        let currentItemType = null;

        const icons = {
            masques: 'üé≠',
            tuyaux: 'üîß',
            moteurs: '‚öôÔ∏è',
            batteries: 'üîã'
        };

        const names = {
            masques: 'Masque',
            tuyaux: 'Tuyau',
            moteurs: 'Moteur',
            batteries: 'Batterie'
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            updateAllDates();
            renderAll();
            updateKPIs();
            renderAllCharts();
        });

        function updateAllDates() {
            const today = new Date().toLocaleDateString('fr-FR');
            ['masques', 'tuyaux', 'moteurs', 'batteries'].forEach(type => {
                document.getElementById(`date-${type}`).textContent = today;
            });
        }

        function switchTab(type) {
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Activer l'onglet s√©lectionn√©
            event.target.classList.add('active');
            document.getElementById(`content-${type}`).classList.add('active');
            
            currentTab = type;
        }

        function addItem(type, statut) {
            const reference = document.getElementById(`ref-${type}`).value.trim();
            const numero = document.getElementById(`num-${type}`).value.trim();

            if (!reference || !numero) {
                alert('‚ö†Ô∏è Veuillez remplir la r√©f√©rence et le num√©ro');
                return;
            }

            const today = new Date();
            const dateReception = today.toISOString().split('T')[0];
            
            let dateExpiration;
            let dateService = null;

            // Pour le moment : 3 ans pour tous
            const expiration = new Date(today);
            expiration.setFullYear(expiration.getFullYear() + 3);
            dateExpiration = expiration.toISOString().split('T')[0];

            if (statut === 'utilisation') {
                dateService = dateReception;
            }

            const newItem = {
                id: Date.now(),
                reference: reference,
                numero: numero,
                dateReception: dateReception,
                dateService: dateService,
                dateExpiration: dateExpiration,
                statut: statut,
                historique: [
                    {
                        date: new Date().toISOString(),
                        type: 'creation',
                        note: `${names[type]} cr√©√© en ${statut === 'stock' ? 'STOCK' : 'UTILISATION'} (3 ans)`
                    }
                ]
            };

            data[type].push(newItem);
            saveData(type);
            renderItems(type);
            updateKPIs();
            renderChart(type);
            
            document.getElementById(`ref-${type}`).value = '';
            document.getElementById(`num-${type}`).value = '';
            
            alert(`‚úÖ ${names[type]} ajout√© avec succ√®s !`);
        }

        function renderAll() {
            ['masques', 'tuyaux', 'moteurs', 'batteries'].forEach(type => {
                renderItems(type);
            });
        }

        function renderItems(type) {
            const container = document.getElementById(`list-${type}`);
            container.innerHTML = '';

            if (data[type].length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun √©quipement enregistr√©</p>';
                return;
            }

            data[type].forEach(item => {
                const statusClass = item.statut;
                const statusText = item.statut === 'stock' ? 'üì¶ En Stock' : 'üîµ En Utilisation';

                const dateReception = new Date(item.dateReception);
                const dateExpiration = new Date(item.dateExpiration);
                
                const maintenances = item.historique.filter(h => h.type === 'maintenance').length;

                const div = document.createElement('div');
                div.className = `item ${statusClass}`;
                div.innerHTML = `
                    <div class="item-header">
                        <div class="item-ref">${icons[type]} ${item.reference} - ${item.numero}</div>
                        <div class="item-status status-${statusClass}">${statusText}</div>
                    </div>
                    <div class="item-info">
                        <div><strong>üìÖ R√©ception:</strong> ${formatDate(dateReception)}</div>
                        <div><strong>‚è≥ Expire:</strong> ${formatDate(dateExpiration)}</div>
                        ${item.dateService ? `<div class="item-info-full"><strong>üîµ Mis en service:</strong> ${formatDate(new Date(item.dateService))}</div>` : ''}
                        <div class="item-info-full"><strong>üîß Maintenances:</strong> ${maintenances}</div>
                    </div>
                    <div class="item-actions">
                        ${item.statut === 'stock' ? 
                            `<button class="btn-small btn-service" onclick="openServiceModal('${type}', ${item.id})">üîµ Mettre en Service</button>` :
                            `<button class="btn-small btn-edit" onclick="openMaintenanceModal('${type}', ${item.id})">üîß Ajouter Maintenance</button>`
                        }
                        <button class="btn-small btn-history" onclick="showHistory('${type}', ${item.id})">üìú Historique</button>
                        <button class="btn-small btn-delete" onclick="openDeleteModal('${type}', ${item.id})">üóëÔ∏è Supprimer</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openServiceModal(type, id) {
            currentItemType = type;
            currentItemId = id;
            document.getElementById('dateService').value = new Date().toISOString().split('T')[0];
            document.getElementById('serviceModal').classList.add('active');
        }

        function confirmMiseEnService() {
            const item = data[currentItemType].find(m => m.id === currentItemId);
            if (!item) return;

            const dateService = document.getElementById('dateService').value;
            if (!dateService) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une date');
                return;
            }

            item.statut = 'utilisation';
            item.dateService = dateService;
            
            // Recalculer expiration : 3 ans √† partir de la mise en service
            const expiration = new Date(dateService);
            expiration.setFullYear(expiration.getFullYear() + 3);
            item.dateExpiration = expiration.toISOString().split('T')[0];

            item.historique.push({
                date: new Date().toISOString(),
                type: 'mise-en-service',
                note: `${names[currentItemType]} mis en service (3 ans). Nouvelle expiration: ${formatDate(expiration)}`
            });

            saveData(currentItemType);
            renderItems(currentItemType);
            updateKPIs();
            renderChart(currentItemType);
            closeModal('serviceModal');
            alert(`‚úÖ ${names[currentItemType]} mis en service avec succ√®s !`);
        }

        function openMaintenanceModal(type, id) {
            currentItemType = type;
            currentItemId = id;
            document.getElementById('dateMaintenance').value = new Date().toISOString().split('T')[0];
            document.getElementById('commentaireMaintenance').value = '';
            document.getElementById('maintenanceModal').classList.add('active');
        }

        function confirmMaintenance() {
            const item = data[currentItemType].find(m => m.id === currentItemId);
            if (!item) return;

            const dateMaintenance = document.getElementById('dateMaintenance').value;
            const commentaire = document.getElementById('commentaireMaintenance').value;

            if (!dateMaintenance) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une date');
                return;
            }

            item.historique.push({
                date: new Date(dateMaintenance).toISOString(),
                type: 'maintenance',
                note: commentaire || 'Maintenance effectu√©e'
            });

            saveData(currentItemType);
            renderItems(currentItemType);
            updateKPIs();
            closeModal('maintenanceModal');
            alert('‚úÖ Maintenance enregistr√©e !');
        }

        function showHistory(type, id) {
            const item = data[type].find(m => m.id === id);
            if (!item) return;

            const container = document.getElementById('historyContent');
            container.innerHTML = `
                <h3>${icons[type]} ${item.reference} - ${item.numero}</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Statut: <strong>${item.statut === 'stock' ? 'üì¶ Stock' : 'üîµ Utilisation'}</strong>
                </p>
            `;

            if (item.historique.length === 0) {
                container.innerHTML += '<p style="text-align: center; color: #999; padding: 20px;">Aucun historique</p>';
            } else {
                const sortedHistory = [...item.historique].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedHistory.forEach(event => {
                    const typeClass = `type-${event.type}`;
                    const typeText = {
                        'creation': '‚ú® Cr√©ation',
                        'maintenance': 'üîß Maintenance',
                        'mise-en-service': 'üîµ Mise en Service'
                    }[event.type] || event.type;

                    container.innerHTML += `
                        <div class="history-item">
                            <div class="history-date">${formatDateTime(event.date)}</div>
                            <span class="history-type ${typeClass}">${typeText}</span>
                            <p>${event.note}</p>
                        </div>
                    `;
                });
            }

            document.getElementById('historyModal').classList.add('active');
        }

        function openDeleteModal(type, id) {
            const item = data[type].find(m => m.id === id);
            if (!item) return;

            currentItemType = type;
            currentItemId = id;

            const statusText = item.statut === 'stock' ? 'üì¶ En Stock' : 'üîµ En Utilisation';
            const maintenances = item.historique.filter(h => h.type === 'maintenance').length;

            document.getElementById('deleteInfo').innerHTML = `
                <div style="font-size: 1.2em; margin-bottom: 10px;">${icons[type]} ${item.reference} - ${item.numero}</div>
                <div>Type: ${names[type]}</div>
                <div>Statut: ${statusText}</div>
                <div>Date de r√©ception: ${formatDate(new Date(item.dateReception))}</div>
                <div>Maintenances: ${maintenances}</div>
                <div>Total √©v√©nements: ${item.historique.length}</div>
            `;

            document.getElementById('deleteModal').classList.add('active');
        }

        function confirmDelete() {
            const index = data[currentItemType].findIndex(m => m.id === currentItemId);
            if (index === -1) return;

            const item = data[currentItemType][index];
            const itemInfo = `${icons[currentItemType]} ${item.reference} - ${item.numero}`;

            data[currentItemType].splice(index, 1);
            saveData(currentItemType);
            renderItems(currentItemType);
            updateKPIs();
            renderChart(currentItemType);
            closeModal('deleteModal');

            alert(`‚úÖ ${names[currentItemType]} "${itemInfo}" supprim√© d√©finitivement !`);
        }

        function updateKPIs() {
            // KPIs par type
            document.getElementById('kpi-masques').textContent = data.masques.length;
            document.getElementById('kpi-tuyaux').textContent = data.tuyaux.length;
            document.getElementById('kpi-moteurs').textContent = data.moteurs.length;
            document.getElementById('kpi-batteries').textContent = data.batteries.length;

            // Total maintenances
            const totalMaintenances = ['masques', 'tuyaux', 'moteurs', 'batteries'].reduce((acc, type) => {
                return acc + data[type].reduce((sum, item) => {
                    return sum + item.historique.filter(h => h.type === 'maintenance').length;
                }, 0);
            }, 0);

            document.getElementById('kpi-maintenances').textContent = totalMaintenances;
        }

        function renderAllCharts() {
            ['masques', 'tuyaux', 'moteurs', 'batteries'].forEach(type => {
                renderChart(type);
            });
        }

        function renderChart(type) {
            const ctx = document.getElementById(`chart-${type}`).getContext('2d');
            
            const stats = {
                stock: data[type].filter(m => m.statut === 'stock').length,
                utilisation: data[type].filter(m => m.statut === 'utilisation').length
            };

            if (charts[type]) charts[type].destroy();

            charts[type] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['En Stock', 'En Utilisation'],
                    datasets: [{
                        data: [stats.stock, stats.utilisation],
                        backgroundColor: ['#f59e0b', '#3b82f6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function exportToExcel() {
            const allData = [];
            
            ['masques', 'tuyaux', 'moteurs', 'batteries'].forEach(type => {
                data[type].forEach(item => {
                    allData.push({
                        'Type': names[type],
                        'R√©f√©rence': item.reference,
                        'Num√©ro': item.numero,
                        'Statut': item.statut === 'stock' ? 'Stock' : 'Utilisation',
                        'Date R√©ception': item.dateReception,
                        'Date Mise en Service': item.dateService || 'N/A',
                        'Date Expiration': item.dateExpiration,
                        'Maintenances': item.historique.filter(h => h.type === 'maintenance').length,
                        'Total √âv√©nements': item.historique.length
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(allData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Equipements");
            XLSX.writeFile(wb, `Equipements_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportAllToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text('FICHE AUDIT - EQUIPEMENTS VENTILATION', 105, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`Date: ${formatDate(new Date())}`, 20, 35);

            let y = 45;

            ['masques', 'tuyaux', 'moteurs', 'batteries'].forEach(type => {
                if (y > 260) {
                    doc.addPage();
                    y = 20;
                }

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`${icons[type]} ${names[type].toUpperCase()}S`, 20, y);
                y += 10;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Total: ${data[type].length}`, 20, y);
                doc.text(`Stock: ${data[type].filter(m => m.statut === 'stock').length}`, 60, y);
                doc.text(`Utilisation: ${data[type].filter(m => m.statut === 'utilisation').length}`, 100, y);
                y += 10;

                data[type].forEach(item => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFontSize(9);
                    doc.text(`${item.reference} - ${item.numero}`, 25, y);
                    doc.text(`[${item.statut === 'stock' ? 'Stock' : 'Utilisation'}]`, 90, y);
                    doc.text(`Exp: ${item.dateExpiration}`, 130, y);
                    y += 5;
                });

                y += 10;
            });

            doc.save(`Audit_Equipements_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function formatDate(date) {
            if (typeof date === 'string') date = new Date(date);
            return date.toLocaleDateString('fr-FR');
        }

        function formatDateTime(date) {
            if (typeof date === 'string') date = new Date(date);
            return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
        }

        function saveData(type) {
            localStorage.setItem(type, JSON.stringify(data[type]));
        }
    </script>
</body>
</html>
