<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panneau d'administration PPVE - Gestion des utilisateurs, permissions et acc√®s au syst√®me de casiers">
    <meta name="keywords" content="administration, gestion utilisateurs, permissions, PPVE admin">
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="canonical" href="https://behui.github.io/Gestion-EPI/admin-test.html">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com; font-src 'self' data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    
    <title>Administration - Gestion Utilisateurs & Permissions | PPVE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: white;
            color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .permissions-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .permissions-section.show {
            display: block;
        }

        .permissions-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .permission-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .permission-item label {
            cursor: pointer;
            font-size: 0.95em;
            margin: 0;
            flex: 1;
        }

        .btn {
            padding: 12px 25px;
            min-height: 44px;
            min-width: 44px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-edit {
            background: #f59e0b;
            color: white;
            padding: 8px 16px;
            font-size: 0.85em;
            margin-right: 8px;
        }

        .btn-edit:hover {
            background: #d97706;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .users-table th {
            background: #f8f9fa;
            color: #667eea;
            font-weight: 600;
            font-size: 0.9em;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        .badge-admin {
            background: #667eea;
            color: white;
        }

        .badge-user {
            background: #3498db;
            color: white;
        }

        .badge-hybrid {
            background: #f59e0b;
            color: white;
        }

        .permissions-summary {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .permissions-summary .perm-icon {
            margin-right: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideIn 0.3s;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            color: #667eea;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .uid-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            margin: 15px 0;
            border: 2px solid #667eea;
            word-break: break-all;
        }

        .uid-label {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .copy-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #45a049;
        }

        /* === RESPONSIVE MOBILE === */
        @media (max-width: 1024px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }

            .permissions-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .header > div {
                width: 100%;
            }

            .header > div:first-child {
                flex-direction: column;
                gap: 10px;
            }

            .header > div:last-child {
                flex-direction: column;
            }

            .btn-logout {
                width: 100%;
                padding: 12px;
            }

            .card {
                padding: 15px;
            }

            .card h2 {
                font-size: 1.2em;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .permissions-grid {
                grid-template-columns: 1fr;
            }

            .users-table {
                font-size: 0.85em;
            }

            .users-table th,
            .users-table td {
                padding: 8px 5px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9em;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.1em;
            }

            .users-table {
                display: block;
                overflow-x: auto;
            }

            .badge {
                font-size: 0.75em;
                padding: 3px 8px;
            }

            .btn-edit,
            .btn-danger {
                padding: 6px 12px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <!-- Skip Navigation for Accessibility -->
    <a href="#main-content" class="skip-link" style="position: absolute; left: -9999px; z-index: 999; padding: 1em; background: #667eea; color: white; text-decoration: none;">Aller au contenu principal</a>
    <style>.skip-link:focus { left: 10px; top: 10px; }</style>
    
    <div class="header" id="main-content">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div>
                <h1><span aria-hidden="true">üë§</span> Administration - Gestion Utilisateurs et Permissions PPVE</h1>
                <p id="admin-info" style="opacity: 0.9; margin-top: 5px;"></p>
            </div>
            <button id="admin-tools-btn" class="btn-logout" onclick="location.href='admin-administrator.html'" style="background: linear-gradient(135deg, #ff0080 0%, #7928ca 100%); border: none;">
                üîß Admin Tools
            </button>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn-logout" onclick="location.href='gestion-casiers.html'">
                üè† Retour √† l'application
            </button>
            <button class="btn-logout" onclick="logout()">
                üö™ D√©connexion
            </button>
        </div>
    </div>

    <div class="container">
        <div id="alert" class="alert"></div>

        <!-- Formulaire d'ajout d'utilisateur -->
        <div class="card">
            <h2>‚ûï Cr√©er un Nouvel Utilisateur</h2>
            <form id="add-user-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="prenom">Pr√©nom *</label>
                        <input type="text" id="prenom" required>
                    </div>
                    <div class="form-group">
                        <label for="nom">Nom *</label>
                        <input type="text" id="nom" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Mot de passe * (min. 6 car.)</label>
                        <input type="password" id="password" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label for="password-confirm">Confirmer mot de passe *</label>
                        <input type="password" id="password-confirm" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label for="role">R√¥le *</label>
                        <select id="role" required onchange="togglePermissions()">
                            <option value="">-- Choisir --</option>
                            <option value="utilisateur">üë§ Utilisateur</option>
                            <option value="admin">üîë Administrateur</option>
                        </select>
                    </div>
                </div>

                <!-- Permissions avanc√©es (visible uniquement pour utilisateur) -->
                <div id="permissions-section" class="permissions-section">
                    <h3>‚öôÔ∏è Permissions Avanc√©es (Profil Hybride)</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        Cochez les permissions pour cr√©er un utilisateur avec acc√®s sp√©cifiques.
                    </p>
                    <div class="permissions-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="perm-view-casiers">
                            <label for="perm-view-casiers">
                                <strong>üëÅÔ∏è Voir Vue d'ensemble Casiers</strong><br>
                                <small style="color: #666;">Consulter les casiers en lecture seule</small>
                            </label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-edit-casiers">
                            <label for="perm-edit-casiers">
                                <strong>‚úèÔ∏è Modifier les Casiers</strong><br>
                                <small style="color: #666;">Attribuer/Lib√©rer des casiers</small>
                            </label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-view-equipements">
                            <label for="perm-view-equipements">
                                <strong>üëÅÔ∏è Voir Gestion √âquipements</strong><br>
                                <small style="color: #666;">Consulter les √©quipements</small>
                            </label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-edit-equipements">
                            <label for="perm-edit-equipements">
                                <strong>‚úèÔ∏è Modifier les √âquipements</strong><br>
                                <small style="color: #666;">G√©rer le stock/maintenance</small>
                            </label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="add-btn" style="margin-top: 20px;">
                    ‚úÖ Cr√©er l'Utilisateur
                </button>
            </form>
        </div>

        <!-- Liste des utilisateurs -->
        <div class="card">
            <h2>üìã Liste des Utilisateurs</h2>
            <div id="users-container"></div>
        </div>
    </div>

    <!-- Modal d'√©dition des permissions -->
    <div id="edit-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="edit-modal-title"><span aria-hidden="true">‚öôÔ∏è</span> Modifier les Permissions</h3>
                <button class="close-modal" onclick="closeEditModal()" aria-label="Fermer la modale">&times;</button>
            </div>
            <div id="edit-form-container"></div>
        </div>
    </div>

    <!-- Modal de cr√©ation profil Firestore apr√®s Authentication -->
    <div id="firestore-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="firestore-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="firestore-modal-title"><span aria-hidden="true">üîë</span> Cr√©ation Profil Firestore</h3>
                <button class="close-modal" onclick="closeFirestoreModal()" aria-label="Fermer la modale">&times;</button>
            </div>
            <div id="firestore-form-container"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDMPBik5vpX8qOYWuhPzpJZoOLjE20pl6g",
            authDomain: "gestion-epi-4387a.firebaseapp.com",
            projectId: "gestion-epi-4387a",
            storageBucket: "gestion-epi-4387a.firebasestorage.app",
            messagingSenderId: "974706767408",
            appId: "1:974706767408:web:fde01e52a3a986d6da9ff5",
            measurementId: "G-PKNXH32P0Z"
        };

        const app = initializeApp(firebaseConfig);
        
        // üîí Firebase App Check - TEMPORAIREMENT D√âSACTIV√â
        // RAISON: Cause des erreurs "network-request-failed" qui bloquent la connexion
        // TODO: R√©activer apr√®s configuration compl√®te dans Firebase Console
        /*
        try {
            const appCheck = initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider('6LdVPo8qAAAAAJTMf1VMEFhD_pEPe0dKc_B7VF3W'),
                isTokenAutoRefreshEnabled: true
            });
        } catch (error) {
            console.warn('‚ö†Ô∏è App Check d√©sactiv√©');
        }
        */
        console.log('‚ö†Ô∏è App Check d√©sactiv√© temporairement');
        
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ÔøΩ CONSTANTS (Code Quality - Phase 1)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const USER_ROLES = {
            ADMIN: 'admin',
            USER: 'utilisateur'
        };

        const MESSAGES = {
            SUCCESS: {
                USER_CREATED: (prenom, nom, email) => `‚úÖ Utilisateur cr√©√© : ${prenom} ${nom} (${email})`,
                USER_DELETED: (nom) => `‚úÖ Utilisateur ${nom} supprim√©`,
                PERMISSIONS_UPDATED: '‚úÖ Permissions mises √† jour'
            },
            ERROR: {
                INVALID_NAME: '‚ùå Le pr√©nom/nom doit contenir entre 2 et 50 caract√®res (lettres uniquement)',
                INVALID_EMAIL: '‚ùå Format email invalide',
                INVALID_PASSWORD: '‚ùå Le mot de passe doit contenir au moins 6 caract√®res',
                PASSWORD_MISMATCH: '‚ùå Les mots de passe ne correspondent pas',
                EMAIL_EXISTS: '‚ùå Cet email est d√©j√† utilis√©',
                CREATE_FAILED: '‚ùå Erreur lors de la cr√©ation de l\'utilisateur',
                DELETE_FAILED: '‚ùå Erreur lors de la suppression'
            },
            CONFIRM: {
                DELETE_USER: (nom) => `‚ö†Ô∏è Confirmer la suppression de ${nom} ?`
            }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ÔøΩüõ†Ô∏è UTILITY FUNCTIONS (Code Quality Improvement)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        /**
         * Valide un format email
         * @param {string} email - L'email √† valider
         * @returns {boolean} true si valide
         */
        function validateEmail(email) {
            if (!email || typeof email !== 'string') return false;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email.trim());
        }

        /**
         * Valide un pr√©nom ou nom (2-50 caract√®res)
         * @param {string} name - Le nom √† valider
         * @returns {boolean} true si valide
         */
        function validateName(name) {
            if (!name || typeof name !== 'string') return false;
            const trimmed = name.trim();
            return trimmed.length >= 2 && trimmed.length <= 50 && /^[a-zA-Z√Ä-√ø\s\-']+$/.test(trimmed);
        }

        /**
         * Sanitize une cha√Æne de caract√®res
         * @param {string} str - La cha√Æne √† nettoyer
         * @returns {string} Cha√Æne nettoy√©e
         */
        function sanitizeString(str) {
            if (!str || typeof str !== 'string') return '';
            return str.trim().replace(/\s+/g, ' ');
        }

        /**
         * Log une action administrateur pour audit
         * @param {string} action - Type d'action
         * @param {Object} details - D√©tails de l'action
         */
        function logAdminAction(action, details) {
            console.log(`üîê [ADMIN] [${new Date().toISOString()}] ${action}:`, details);
        }

        /**
         * Affiche un message d'erreur utilisateur
         * @param {string} message - Le message d'erreur
         */
        function showUserError(message) {
            console.error('‚ùå', message);
            alert(message);
        }

        // V√©rifier l'authentification ET le r√¥le admin
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                console.log('‚ùå Pas d\'utilisateur connect√©');
                window.location.href = 'index.html';
                return;
            }

            console.log('‚úÖ Utilisateur connect√©:', user.email, 'UID:', user.uid);

            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                // V√âRIFICATION ADMIN OBLIGATOIRE
                if (!userDoc.exists()) {
                    alert('‚õî Acc√®s refus√© : Profil utilisateur introuvable');
                    window.location.href = 'gestion-casiers.html';
                    return;
                }
                
                const userData = userDoc.data();
                if (userData.role !== USER_ROLES.ADMIN) {
                    alert('‚õî Acc√®s refus√© : Cette page est r√©serv√©e aux administrateurs');
                    window.location.href = 'gestion-casiers.html';
                    return;
                }
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    console.log('‚úÖ Profil charg√©:', userData);
                    document.getElementById('admin-info').textContent = 
                        `Connect√© en tant que: ${userData.prenom} ${userData.nom}`;
                } else {
                    console.log('‚ö†Ô∏è Profil Firestore introuvable, mais acc√®s autoris√©');
                    document.getElementById('admin-info').textContent = 
                        `Connect√© en tant que: ${user.email}`;
                }
                
                loadUsers();
            } catch (error) {
                console.error('‚ö†Ô∏è Erreur chargement profil:', error);
                document.getElementById('admin-info').textContent = 
                    `Connect√© en tant que: ${user.email}`;
                loadUsers();
            }
        });

        function showAlert(message, type) {
            const alertBox = document.getElementById('alert');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        window.togglePermissions = function() {
            const role = document.getElementById('role').value;
            const permSection = document.getElementById('permissions-section');
            
            if (role === 'utilisateur') {
                permSection.classList.add('show');
            } else {
                permSection.classList.remove('show');
            }
        };

        function getPermissions() {
            return {
                viewCasiers: document.getElementById('perm-view-casiers').checked,
                editCasiers: document.getElementById('perm-edit-casiers').checked,
                viewEquipements: document.getElementById('perm-view-equipements').checked,
                editEquipements: document.getElementById('perm-edit-equipements').checked
            };
        }

        // Cr√©er un utilisateur
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('add-btn');
            const prenom = document.getElementById('prenom').value.trim();
            const nom = document.getElementById('nom').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('password-confirm').value;
            const role = document.getElementById('role').value;

            // Validation
            if (!prenom || !nom || !email || !password || !passwordConfirm || !role) {
                showAlert('‚ùå Veuillez remplir tous les champs obligatoires.', 'error');
                return;
            }

            // V√©rification correspondance des mots de passe
            if (password !== passwordConfirm) {
                showAlert(MESSAGES.ERROR.PASSWORD_MISMATCH, 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Cr√©ation en cours...';

            // Sauvegarder l'admin actuel avant de cr√©er le nouveau compte
            const currentAdmin = auth.currentUser;
            const currentAdminEmail = currentAdmin.email;

            try {
                // V√©rifier d'abord si l'email existe d√©j√† dans deleted_users
                console.log('üîπ V√©rification si utilisateur supprim√© existe...');
                const deletedUsersSnapshot = await getDocs(collection(db, 'deleted_users'));
                let deletedUserDoc = null;
                let deletedUserId = null;
                
                deletedUsersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.email === email) {
                        deletedUserDoc = data;
                        deletedUserId = doc.id;
                    }
                });

                if (deletedUserDoc) {
                    // L'utilisateur a √©t√© supprim√© pr√©c√©demment, on r√©active son compte
                    console.log('‚úÖ Utilisateur supprim√© trouv√©, UID:', deletedUserId);
                    console.log('üîπ R√©activation du profil Firestore avec les nouvelles donn√©es...');
                    
                    // Pr√©parer les donn√©es utilisateur
                    const userData = {
                        prenom: prenom,
                        nom: nom,
                        email: email,
                        role: role,
                        createdAt: new Date().toISOString(),
                        reactivatedAt: new Date().toISOString(),
                        reactivatedBy: currentAdminEmail,
                        previouslyDeleted: true
                    };

                    // Ajouter les permissions pour les utilisateurs non-admin
                    if (role === 'utilisateur') {
                        userData.permissions = getPermissions();
                        console.log('üîπ Permissions:', userData.permissions);
                    }

                    // Recr√©er le profil Firestore avec l'ancien UID
                    await setDoc(doc(db, 'users', deletedUserId), userData);
                    console.log('‚úÖ Profil Firestore r√©activ√©!');

                    // Supprimer l'entr√©e deleted_users
                    await deleteDoc(doc(db, 'deleted_users', deletedUserId));
                    console.log('‚úÖ Trace de suppression nettoy√©e');

                    showAlert(`‚úÖ Utilisateur ${prenom} ${nom} r√©activ√© avec succ√®s!\n\nüîÑ Le compte Authentication existant a √©t√© r√©utilis√©.\nLe mot de passe reste inchang√©.`, 'success');
                    
                    // Recharger la liste
                    document.getElementById('add-user-form').reset();
                    document.getElementById('permissions-section').classList.remove('show');
                    loadUsers();

                    btn.disabled = false;
                    btn.textContent = '‚úÖ Cr√©er l\'Utilisateur';
                    return;
                }

                // Utilisateur nouveau, proc√©der normalement
                console.log('üîπ Cr√©ation d\'un nouveau compte Authentication pour:', email);
                console.log('üîπ Admin actuel avant cr√©ation:', auth.currentUser ? auth.currentUser.email : 'AUCUN');
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;
                const newUid = newUser.uid;
                
                console.log('‚úÖ Compte Authentication cr√©√©, UID:', newUid);
                console.log('üîπ Utilisateur actuel apr√®s cr√©ation:', auth.currentUser ? auth.currentUser.email : 'AUCUN');

                // IMPORTANT: Pr√©parer les donn√©es AVANT toute op√©ration Firestore
                const userData = {
                    prenom: prenom,
                    nom: nom,
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString(),
                    createdBy: currentAdminEmail
                };

                // Ajouter les permissions pour les utilisateurs non-admin
                if (role === USER_ROLES.USER) {
                    userData.permissions = getPermissions();
                    console.log('üîπ Permissions:', userData.permissions);
                }

                // CR√âER DIRECTEMENT LE PROFIL FIRESTORE (pas de modal)
                console.log('üîπ Cr√©ation profil Firestore...');
                
                try {
                    await setDoc(doc(db, 'users', newUid), userData);
                    console.log('‚úÖ Profil Firestore cr√©√© avec succ√®s');
                    showAlert(MESSAGES.SUCCESS.USER_CREATED(prenom, nom, email), 'success');
                    
                    // Recharger la liste des utilisateurs
                    loadUsers();
                    
                    // R√©initialiser le formulaire
                    document.getElementById('add-user-form').reset();
                } catch (firestoreError) {
                    console.error('‚ùå Erreur cr√©ation Firestore:', firestoreError);
                    showAlert('‚ö†Ô∏è Compte cr√©√© mais erreur Firestore. Utilisez l\'outil de r√©paration.', 'warning');
                }
                
                // R√©initialiser le bouton
                btn.disabled = false;
                btn.textContent = '‚úÖ Cr√©er l\'Utilisateur';
                
                // Redirection automatique supprim√©e - l'admin reste connect√©

            } catch (error) {
                console.error('‚ùå Erreur compl√®te:', error);
                let msg = '‚ùå Erreur lors de la cr√©ation: ' + error.message;
                
                if (error.code === 'auth/email-already-in-use') {
                    msg = MESSAGES.ERROR.EMAIL_EXISTS;
                } else if (error.code === 'auth/weak-password') {
                    msg = '‚ùå Mot de passe trop faible (minimum 6 caract√®res).';
                } else if (error.code === 'auth/invalid-email') {
                    msg = '‚ùå Format d\'email invalide.';
                } else if (error.code === 'auth/network-request-failed') {
                    msg = '‚ùå Erreur r√©seau. V√©rifiez votre connexion Internet.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    msg = '‚ùå Op√©ration non autoris√©e. Contactez l\'administrateur syst√®me.';
                } else if (error.code === 'auth/too-many-requests') {
                    msg = '‚ùå Trop de tentatives. R√©essayez dans quelques minutes.';
                } else if (error.code === 'permission-denied') {
                    msg = '‚ùå Permissions insuffisantes. V√©rifiez vos droits Firebase.';
                }
                
                showAlert(msg, 'error');
                
                btn.disabled = false;
                btn.textContent = '‚úÖ Cr√©er l\'Utilisateur';
            }
        });

        // Charger la liste des utilisateurs
        async function loadUsers() {
            const container = document.getElementById('users-container');
            container.innerHTML = '<p style="text-align:center; padding:20px;">‚è≥ Chargement...</p>';

            try {
                const snapshot = await getDocs(collection(db, 'users'));
                
                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align:center; padding:40px; color:#999;">Aucun utilisateur trouv√©.</p>';
                    return;
                }

                let html = '<table class="users-table"><thead><tr>';
                html += '<th>Utilisateur</th><th>Email</th><th>R√¥le</th><th>Permissions</th><th>Actions</th>';
                html += '</tr></thead><tbody>';

                snapshot.forEach(doc => {
                    const user = doc.data();
                    const uid = doc.id;
                    
                    let badgeClass = user.role === USER_ROLES.ADMIN ? 'badge-admin' : 'badge-user';
                    let badgeText = user.role === USER_ROLES.ADMIN ? 'üîë Admin' : 'üë§ Utilisateur';
                    
                    // V√©rifier si c'est un profil hybride
                    const perms = user.permissions || {};
                    const hasPerms = perms.viewCasiers || perms.editCasiers || perms.viewEquipements || perms.editEquipements;
                    
                    if (user.role === USER_ROLES.USER && hasPerms) {
                        badgeClass = 'badge-hybrid';
                        badgeText = '‚ö° Hybride';
                    }

                    let permSummary = '';
                    if (user.role === USER_ROLES.ADMIN) {
                        permSummary = '<span class="permissions-summary">‚úÖ Acc√®s complet</span>';
                    } else if (hasPerms) {
                        permSummary = '<div class="permissions-summary">';
                        if (perms.viewCasiers) permSummary += '<span class="perm-icon">üëÅÔ∏èüì¶</span>';
                        if (perms.editCasiers) permSummary += '<span class="perm-icon">‚úèÔ∏èüì¶</span>';
                        if (perms.viewEquipements) permSummary += '<span class="perm-icon">üëÅÔ∏èüé≠</span>';
                        if (perms.editEquipements) permSummary += '<span class="perm-icon">‚úèÔ∏èüé≠</span>';
                        permSummary += '</div>';
                    } else {
                        permSummary = '<span class="permissions-summary" style="color:#999;">Espace utilisateur uniquement</span>';
                    }

                    html += `<tr>
                        <td><strong>${user.prenom} ${user.nom}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="badge ${badgeClass}">${badgeText}</span></td>
                        <td>${permSummary}</td>
                        <td>
                            ${user.role !== USER_ROLES.ADMIN ? `<button class="btn btn-edit" onclick="editPermissions('${uid}')">‚öôÔ∏è Permissions</button>` : ''}
                            <button class="btn btn-danger" onclick="deleteUser('${uid}', '${user.email}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Erreur chargement:', error);
                container.innerHTML = '<p style="text-align:center; padding:20px; color:red;">‚ùå Erreur de chargement</p>';
            }
        }

        /**
         * Ouvre le modal d'√©dition des permissions pour un utilisateur
         * @param {string} userId - L'UID de l'utilisateur
         */
        window.editPermissions = async function(userId) {
            try {
                logAdminAction('OPEN_EDIT_PERMISSIONS', { userId });
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (!userDoc.exists()) {
                    showUserError('‚ùå Utilisateur introuvable');
                    return;
                }

                const userData = userDoc.data();
                const perms = userData.permissions || {};

                const container = document.getElementById('edit-form-container');
                container.innerHTML = `
                    <p style="margin-bottom: 15px;">
                        <strong>Utilisateur:</strong> ${userData.prenom} ${userData.nom}<br>
                        <strong>Email:</strong> ${userData.email}
                    </p>
                    <div class="permissions-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="edit-perm-view-casiers" ${perms.viewCasiers ? 'checked' : ''}>
                            <label for="edit-perm-view-casiers"><strong>üëÅÔ∏è Voir Casiers</strong></label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit-perm-edit-casiers" ${perms.editCasiers ? 'checked' : ''}>
                            <label for="edit-perm-edit-casiers"><strong>‚úèÔ∏è Modifier Casiers</strong></label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit-perm-view-equipements" ${perms.viewEquipements ? 'checked' : ''}>
                            <label for="edit-perm-view-equipements"><strong>üëÅÔ∏è Voir √âquipements</strong></label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit-perm-edit-equipements" ${perms.editEquipements ? 'checked' : ''}>
                            <label for="edit-perm-edit-equipements"><strong>‚úèÔ∏è Modifier √âquipements</strong></label>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="savePermissions('${userId}')">
                        üíæ Enregistrer les Permissions
                    </button>
                `;

                document.getElementById('edit-modal').classList.add('show');
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur lors du chargement des permissions.', 'error');
            }
        };

        window.savePermissions = async function(userId) {
            try {
                const newPerms = {
                    viewCasiers: document.getElementById('edit-perm-view-casiers').checked,
                    editCasiers: document.getElementById('edit-perm-edit-casiers').checked,
                    viewEquipements: document.getElementById('edit-perm-view-equipements').checked,
                    editEquipements: document.getElementById('edit-perm-edit-equipements').checked
                };

                await updateDoc(doc(db, 'users', userId), {
                    permissions: newPerms
                });

                showAlert(MESSAGES.SUCCESS.PERMISSIONS_UPDATED, 'success');
                closeEditModal();
                loadUsers();
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('‚ùå Erreur lors de la sauvegarde.', 'error');
            }
        };

        window.closeEditModal = function() {
            document.getElementById('edit-modal').classList.remove('show');
        };

        /**
         * Supprime un utilisateur avec confirmation s√©curis√©e
         * @param {string} userId - L'UID de l'utilisateur
         * @param {string} userEmail - L'email de l'utilisateur
         */
        window.deleteUser = async function(userId, userEmail) {
            logAdminAction('DELETE_USER_ATTEMPT', { userId, userEmail });
            // R√©cup√©rer le nom de l'utilisateur
            let userName = userEmail;
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    userName = `${data.prenom} ${data.nom}`;
                }
            } catch (e) {
                console.error('Erreur r√©cup√©ration infos:', e);
            }

            // Demander confirmation en tapant SUPPRIMER
            const confirmText = prompt(`‚ö†Ô∏è CONFIRMATION\n\nPour supprimer ${userName}, tapez:\nSUPPRIMER`);
            
            if (confirmText !== 'SUPPRIMER') {
                return;
            }

            try {
                console.log('üîπ Suppression du profil Firestore:', userId);
                
                // Cr√©er une trace de la suppression
                await setDoc(doc(db, 'deleted_users', userId), {
                    email: userEmail,
                    deletedAt: new Date().toISOString(),
                    deletedBy: auth.currentUser ? auth.currentUser.email : 'unknown',
                    userName: userName
                });
                
                // Supprimer le document Firestore
                await deleteDoc(doc(db, 'users', userId));
                console.log('‚úÖ Profil supprim√©');
                
                showAlert(MESSAGES.SUCCESS.USER_DELETED(userName), 'success');
                loadUsers();
            } catch (error) {
                console.error('‚ùå Erreur suppression:', error);
                showAlert('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        window.closeFirestoreModal = function() {
            document.getElementById('firestore-modal').classList.remove('show');
        };

        window.showFirestoreModal = function(uid, email, prenom, nom, role, permissions) {
            const container = document.getElementById('firestore-form-container');
            
            const isAdmin = role === USER_ROLES.ADMIN;
            const adminNote = isAdmin ? '<div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; font-size: 14px; color: #1b5e20;">‚úÖ <strong>Administrateur:</strong> Acc√®s complet √† toutes les fonctionnalit√©s par d√©faut.</div>' : '';
            
            container.innerHTML = `
                <div class="status-box status-info" style="background: #e3f2fd; border: 2px solid #2196f3; color: #0d47a1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    ‚úÖ Compte Firebase Authentication cr√©√© avec succ√®s!<br>
                    üìù Compl√©tez maintenant le profil Firestore ci-dessous.
                </div>

                <div class="uid-label">üîë UID Firebase (copiez-le si besoin):</div>
                <div class="uid-display" id="uid-display">${uid}</div>
                <button class="copy-btn" onclick="copyUID('${uid}')">üìã Copier l'UID</button>

                <form id="firestore-create-form" style="margin-top: 25px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email:</label>
                        <input type="text" id="fs-email" value="${email}" readonly style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: #f5f5f5;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Pr√©nom:</label>
                        <input type="text" id="fs-prenom" value="${prenom}" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nom:</label>
                        <input type="text" id="fs-nom" value="${nom}" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">R√¥le:</label>
                        <select id="fs-role" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" onchange="toggleFsPermissions()">
                            <option value="utilisateur" ${role === 'utilisateur' ? 'selected' : ''}>üë§ Utilisateur</option>
                            <option value="admin" ${role === 'admin' ? 'selected' : ''}>üîë Administrateur</option>
                        </select>
                        ${adminNote}
                    </div>

                    <div id="fs-permissions-section" style="${isAdmin ? 'display: none;' : 'display: block;'} margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">‚öôÔ∏è Permissions Avanc√©es</h4>
                        <div class="permissions-grid">
                            <div class="permission-item">
                                <input type="checkbox" id="fs-perm-view-casiers" ${permissions?.viewCasiers ? 'checked' : ''}>
                                <label for="fs-perm-view-casiers"><strong>üëÅÔ∏è Voir Casiers</strong></label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="fs-perm-edit-casiers" ${permissions?.editCasiers ? 'checked' : ''}>
                                <label for="fs-perm-edit-casiers"><strong>‚úèÔ∏è Modifier Casiers</strong></label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="fs-perm-view-equipements" ${permissions?.viewEquipements ? 'checked' : ''}>
                                <label for="fs-perm-view-equipements"><strong>üëÅÔ∏è Voir √âquipements</strong></label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="fs-perm-edit-equipements" ${permissions?.editEquipements ? 'checked' : ''}>
                                <label for="fs-perm-edit-equipements"><strong>‚úèÔ∏è Modifier √âquipements</strong></label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width:100%; margin-top:20px;">
                        üíæ Cr√©er le Profil Firestore Maintenant
                    </button>
                </form>

                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; font-size: 14px;">
                    ‚ö†Ô∏è <strong>Important:</strong> Le compte Authentication existe d√©j√†.<br>
                    Vous devez maintenant cr√©er le profil Firestore pour que l'utilisateur puisse se connecter.
                </div>
            `;

            document.getElementById('firestore-modal').classList.add('show');

            // Gestionnaire du formulaire
            document.getElementById('firestore-create-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createFirestoreProfile(uid);
            });
        };

        window.toggleFsPermissions = function() {
            const role = document.getElementById('fs-role').value;
            const permSection = document.getElementById('fs-permissions-section');
            permSection.style.display = role === 'utilisateur' ? 'block' : 'none';
        };

        window.copyUID = function(uid) {
            navigator.clipboard.writeText(uid).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copi√©!';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#4caf50';
                }, 2000);
            }).catch(err => {
                alert('Erreur copie: ' + err);
            });
        };

        window.createFirestoreProfile = async function(uid) {
            const btn = document.querySelector('#firestore-create-form button[type="submit"]');
            btn.disabled = true;
            btn.textContent = '‚è≥ Cr√©ation en cours...';

            try {
                const prenom = document.getElementById('fs-prenom').value.trim();
                const nom = document.getElementById('fs-nom').value.trim();
                const email = document.getElementById('fs-email').value;
                const role = document.getElementById('fs-role').value;

                const profileData = {
                    prenom: prenom,
                    nom: nom,
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString(),
                    createdBy: auth.currentUser ? auth.currentUser.email : window.pendingUserData.createdBy,
                    createdViaModal: true
                };

                if (role === USER_ROLES.USER) {
                    // Permissions personnalis√©es pour utilisateurs
                    profileData.permissions = {
                        viewCasiers: document.getElementById('fs-perm-view-casiers').checked,
                        editCasiers: document.getElementById('fs-perm-edit-casiers').checked,
                        viewEquipements: document.getElementById('fs-perm-view-equipements').checked,
                        editEquipements: document.getElementById('fs-perm-edit-equipements').checked
                    };
                } else if (role === USER_ROLES.ADMIN) {
                    // Admin = tous les droits par d√©faut (pas de champ permissions)
                    console.log('‚úÖ Profil Admin: Acc√®s complet automatique');
                }

                console.log('üîπ Cr√©ation Firestore avec UID:', uid);
                console.log('üîπ Donn√©es:', profileData);

                await setDoc(doc(db, 'users', uid), profileData);
                console.log('‚úÖ Profil Firestore cr√©√©!');

                // V√©rification
                const verifyDoc = await getDoc(doc(db, 'users', uid));
                if (verifyDoc.exists()) {
                    console.log('‚úÖ V√âRIFICATION OK:', verifyDoc.data());
                    
                    showAlert(`‚úÖ‚úÖ‚úÖ PROFIL COMPLET CR√â√â!\n\nAuthentication: ‚úÖ\nFirestore: ‚úÖ\n\nL'utilisateur ${prenom} ${nom} peut maintenant se connecter!`, 'success');
                    
                    closeFirestoreModal();
                    
                    // Recharger la liste
                    loadUsers();
                    
                    // R√©initialiser le formulaire de cr√©ation
                    document.getElementById('add-user-form').reset();
                    document.getElementById('permissions-section').classList.remove('show');
                } else {
                    throw new Error('Document non trouv√© apr√®s cr√©ation');
                }

            } catch (error) {
                console.error('‚ùå Erreur cr√©ation Firestore:', error);
                showAlert('‚ùå Erreur lors de la cr√©ation Firestore: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'üíæ Cr√©er le Profil Firestore Maintenant';
            }
        };

        window.logout = async function() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                await auth.signOut();
                window.location.href = 'login.html';
            }
        };

        window.loadUsers = loadUsers;
    </script>
</body>
</html>
