rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========== FONCTIONS HELPER SÉCURISÉES ==========
    
    // Vérifier si l'utilisateur est connecté
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Vérifier si l'email est valide et vérifié
    function hasVerifiedEmail() {
      return request.auth != null && 
             request.auth.token.email_verified == true &&
             request.auth.token.email.matches('.*@[a-zA-Z0-9-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Récupérer le rôle de l'utilisateur de manière sécurisée
    function getUserRole() {
      return exists(/databases/$(database)/documents/users/$(request.auth.token.email)) 
        ? get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.role
        : 'none';
    }
    
    // Vérifier si l'utilisateur est admin
    function isAdmin() {
      return hasVerifiedEmail() && getUserRole() == 'admin';
    }
    
    // Vérifier si l'utilisateur est au moins un utilisateur standard
    function isUser() {
      return hasVerifiedEmail() && (getUserRole() == 'utilisateur' || getUserRole() == 'admin');
    }
    
    // Validation des données casiers (sans exposer d'infos sensibles)
    function isValidCasier(data) {
      return data.keys().hasAll(['id', 'platform', 'numero', 'statut']) &&
             data.statut in ['LIBRE', 'EN ATTENTE', 'OCCUPÉ', 'INACTIF'] &&
             data.platform is string &&
             data.numero is int &&
             data.id is string &&
             // Vérifier que les données personnelles ne sont pas trop longues
             (!data.keys().hasAny(['prenom', 'nom']) || 
              (data.prenom.size() < 100 && data.nom.size() < 100));
    }
    
    // Validation des données utilisateur (SANS email stocké)
    function isValidUser(data) {
      return data.keys().hasAll(['role', 'uid']) &&
             data.role in ['utilisateur', 'visiteur'] &&
             // GARANTIR qu'aucun email n'est stocké
             !data.keys().hasAny(['email', 'mail', 'courriel', 'e-mail', 'address']);
    }
    
    // Limite de taille pour les données
    function isReasonableSize(data) {
      return request.resource.size() < 1000000; // 1 MB max
    }
    
    // ========== COLLECTION CASIERS ==========
    match /casiers/{casierId} {
      // Lecture: SEULEMENT par admin (protection maximale)
      // Aucun utilisateur normal ne peut voir les données des autres
      allow read: if isAdmin();
      
      // Création: admin uniquement
      allow create: if isAdmin() && 
                       isValidCasier(request.resource.data) &&
                       isReasonableSize(request.resource.data) &&
                       // INTERDIRE le stockage d'emails dans les casiers
                       !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']);
      
      // Mise à jour: admin uniquement
      allow update: if isAdmin() && 
                       isValidCasier(request.resource.data) &&
                       isReasonableSize(request.resource.data) &&
                       // L'ID ne peut pas être modifié
                       request.resource.data.id == resource.data.id &&
                       // INTERDIRE ajout d'emails
                       !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']);
      
      // Suppression: admin uniquement
      allow delete: if isAdmin();
    }
    
    // ========== COLLECTION UTILISATEURS ==========
    match /users/{userId} {
      // PERSONNE ne peut lire les profils (emails protégés)
      // Chaque utilisateur ne peut voir QUE son propre profil
      allow read: if hasVerifiedEmail() && request.auth.token.email == userId;
      
      // Création: SANS email dans la base (uniquement dans Firebase Auth)
      allow create: if hasVerifiedEmail() && 
                       request.auth.token.email == userId &&
                       // INTERDICTION TOTALE de stocker l'email
                       !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']) &&
                       request.resource.data.keys().hasAll(['role', 'uid']) &&
                       request.resource.data.role in ['utilisateur', 'visiteur'];
      
      // Mise à jour: IMPOSSIBLE d'ajouter un email
      allow update: if hasVerifiedEmail() && 
                       request.auth.token.email == userId &&
                       !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']) &&
                       request.resource.data.role == resource.data.role;
      
      // Suppression: soi-même uniquement
      allow delete: if hasVerifiedEmail() && request.auth.token.email == userId;
    }
    
    // ========== COLLECTION ÉQUIPEMENTS ==========
    match /equipements/{equipementId} {
      allow read: if isUser();
      allow create, update: if isUser() && 
                               isReasonableSize(request.resource.data) &&
                               !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']);
      allow delete: if isUser();
    }
    
    // ========== COLLECTION MASQUES ==========
    match /masques/{masqueId} {
      allow read: if isUser();
      allow write: if isUser() && 
                      isReasonableSize(request.resource.data) &&
                      !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']);
    }
    
    // ========== COLLECTION TUYAUX ==========
    match /tuyaux/{tuyauId} {
      allow read: if isUser();
      allow write: if isUser() && 
                      isReasonableSize(request.resource.data) &&
                      !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']);
    }
    
    // ========== COLLECTION BATTERIES ==========
    match /batteries/{batterieId} {
      allow read: if isUser();
      allow write: if isUser() && 
                      isReasonableSize(request.resource.data) &&
                      !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']);
    }
    
    // ========== COLLECTION MOTEURS ==========
    match /moteurs/{moteurId} {
      allow read: if isUser();
      allow write: if isUser() && 
                      isReasonableSize(request.resource.data) &&
                      !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']);
    }
    
    // ========== COLLECTION LOGS (AUDIT) ==========
    match /logs/{logId} {
      // Lecture: PERSONNE (logs privés)
      allow read: if false;
      
      // Création: utilisateurs authentifiés SANS email
      allow create: if isUser() && 
                       isReasonableSize(request.resource.data) &&
                       !request.resource.data.keys().hasAny(['email', 'mail', 'courriel']);
      
      // Pas de modification/suppression des logs
      allow update, delete: if false;
    }
    
    // ========== BLOCAGE PAR DÉFAUT ==========
    // Toute autre collection est bloquée
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
