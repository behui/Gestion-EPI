<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Centre de contrÃ´le administrateur PPVE - Outils de debug, diagnostic et gestion complÃ¨te du systÃ¨me">
    <meta name="keywords" content="admin tools, debug, diagnostic, Firebase console, PPVE">
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="canonical" href="https://behui.github.io/Gestion-EPI/admin-administrator.html">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com; font-src 'self' data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    
    <title>Admin Administrator - Debug & Tools | PPVE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #ff0080 0%, #7928ca 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(255, 0, 128, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: white;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
        }

        .card:hover {
            border-color: #ff0080;
            box-shadow: 0 6px 30px rgba(255, 0, 128, 0.2);
            transform: translateY(-2px);
        }

        .card h2 {
            color: #ff0080;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
        }

        .card p {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            min-height: 44px;
            min-width: 44px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(86, 171, 47, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
            color: #333;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(242, 153, 74, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(33, 147, 176, 0.4);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 1px solid #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-box:hover {
            border-color: #ff0080;
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #ff0080;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #999;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid;
        }

        .alert.success {
            background: rgba(86, 171, 47, 0.2);
            color: #a8e063;
            border-color: #56ab2f;
        }

        .alert.error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border-color: #ee5a52;
        }

        .alert.warning {
            background: rgba(242, 153, 74, 0.2);
            color: #f2994a;
            border-color: #f2c94c;
        }

        .alert.info {
            background: rgba(33, 147, 176, 0.2);
            color: #6dd5ed;
            border-color: #2193b0;
        }

        .console {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .console-line {
            padding: 5px 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .console-line.success { color: #56ab2f; }
        .console-line.error { color: #ff6b6b; }
        .console-line.warning { color: #f2994a; }
        .console-line.info { color: #6dd5ed; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 15px;
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #ff0080;
        }

        .close-btn {
            background: #333;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 5px;
        }

        .close-btn:hover {
            background: #ff0080;
        }

        pre {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            color: #a8e063;
        }

        .link-box {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .link-box a {
            color: #6dd5ed;
            text-decoration: none;
            display: block;
            padding: 8px 0;
            transition: all 0.3s;
        }

        .link-box a:hover {
            color: #ff0080;
            padding-left: 10px;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge.online {
            background: rgba(86, 171, 47, 0.3);
            color: #a8e063;
        }

        .badge.offline {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #ff0080;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        /* === RESPONSIVE MOBILE === */
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header > div {
                flex-direction: column;
                gap: 15px;
            }

            .header > div > div:last-child {
                flex-direction: column;
                width: 100%;
            }

            .header button {
                width: 100%;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .card {
                padding: 20px;
            }

            .card h2 {
                font-size: 1.2em;
            }

            .btn {
                padding: 12px;
                font-size: 0.95em;
            }

            .console {
                max-height: 300px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3em;
            }

            .header p {
                font-size: 0.9em;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .stat-number {
                font-size: 2em;
            }

            .btn {
                padding: 10px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸ”§ Admin Administrator</h1>
                    <p>Centre de contrÃ´le et debug - AccÃ¨s complet au systÃ¨me</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">ConnectÃ©: <span id="currentUser">Chargement...</span></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="location.href='admin-test.html'" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;">
                        ğŸ‘¤ Gestion Utilisateurs
                    </button>
                    <button onclick="location.href='gestion-casiers.html'" style="padding: 12px 24px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4); transition: all 0.3s;">
                        ğŸ  Retour Application
                    </button>
                </div>
            </div>
        </div>

        <div id="alertBox" class="alert"></div>

        <!-- Statistiques -->
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="statUsers">-</div>
                <div class="stat-label">Utilisateurs</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statCasiers">-</div>
                <div class="stat-label">Casiers</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statDeleted">-</div>
                <div class="stat-label">SupprimÃ©s</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statAuth">-</div>
                <div class="stat-label">Auth Status</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statFirestore">-</div>
                <div class="stat-label">Firestore Status</div>
            </div>
        </div>

        <!-- Outils principaux -->
        <div class="grid">
            <!-- Navigation rapide -->
            <div class="card">
                <h2>ğŸš€ Navigation Rapide</h2>
                <p>AccÃ¨s direct aux diffÃ©rentes interfaces</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="window.location.href='admin-test.html'">
                        ğŸ‘¥ Gestion Utilisateurs
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='gestion-casiers.html'">
                        ğŸ“¦ Gestion Casiers
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='nettoyage-complet.html'">
                        ğŸ§¹ Nettoyage Complet
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='index.html'">
                        ğŸ  Accueil
                    </button>
                </div>
            </div>

            <!-- Firebase Console -->
            <div class="card">
                <h2>ğŸ”¥ Firebase Console</h2>
                <p>AccÃ¨s direct Ã  Firebase</p>
                <div class="btn-group">
                    <button class="btn btn-warning" onclick="openFirebaseConsole()">
                        ğŸ”¥ Console Firebase
                    </button>
                    <button class="btn btn-warning" onclick="openFirebaseAuth()">
                        ğŸ” Authentication
                    </button>
                    <button class="btn btn-warning" onclick="openFirebaseFirestore()">
                        ğŸ’¾ Firestore Database
                    </button>
                    <button class="btn btn-warning" onclick="openFirebaseRules()">
                        ğŸ›¡ï¸ Security Rules
                    </button>
                </div>
            </div>

            <!-- Debug Utilisateurs -->
            <div class="card">
                <h2>ğŸ‘¤ Debug Utilisateurs</h2>
                <p>Outils de diagnostic et rÃ©paration</p>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="scanUsers()">
                        ğŸ” Scanner tous les utilisateurs
                    </button>
                    <button class="btn btn-success" onclick="findOrphans()">
                        ğŸ” Trouver comptes orphelins
                    </button>
                    <button class="btn btn-success" onclick="checkPermissions()">
                        âœ… VÃ©rifier permissions
                    </button>
                    <button class="btn btn-danger" onclick="showModal('repairModal')">
                        ğŸ”§ RÃ©parer profils
                    </button>
                </div>
            </div>

            <!-- Tests Connexion -->
            <div class="card">
                <h2>ğŸ”Œ Tests Connexion</h2>
                <p>Tester les connexions Firebase</p>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="testAuth()">
                        ğŸ” Test Authentication
                    </button>
                    <button class="btn btn-info" onclick="testFirestore()">
                        ğŸ’¾ Test Firestore
                    </button>
                    <button class="btn btn-info" onclick="testSecurityRules()">
                        ğŸ›¡ï¸ Test Security Rules
                    </button>
                    <button class="btn btn-info" onclick="testCompleteFlow()">
                        ğŸ¯ Test Flux Complet
                    </button>
                </div>
            </div>

            <!-- Export/Import -->
            <div class="card">
                <h2>ğŸ’¾ Export / Import</h2>
                <p>Sauvegarde et restauration des donnÃ©es</p>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportUsers()">
                        ğŸ“¤ Export Utilisateurs (JSON)
                    </button>
                    <button class="btn btn-success" onclick="exportCasiers()">
                        ğŸ“¤ Export Casiers (JSON)
                    </button>
                    <button class="btn btn-success" onclick="exportAll()">
                        ğŸ“¤ Export Complet
                    </button>
                    <button class="btn btn-warning" onclick="showModal('importModal')">
                        ğŸ“¥ Import DonnÃ©es
                    </button>
                </div>
            </div>

            <!-- Nettoyage -->
            <div class="card">
                <h2>ğŸ§¹ Nettoyage</h2>
                <p>Nettoyer les donnÃ©es obsolÃ¨tes</p>
                <div class="btn-group">
                    <button class="btn btn-danger" onclick="cleanDeletedUsers()">
                        ğŸ—‘ï¸ Nettoyer traces suppression
                    </button>
                    <button class="btn btn-danger" onclick="cleanOrphanData()">
                        ğŸ—‘ï¸ Nettoyer donnÃ©es orphelines
                    </button>
                    <button class="btn btn-danger" onclick="resetTestData()">
                        âš ï¸ Reset donnÃ©es de test
                    </button>
                    <button class="btn btn-danger" onclick="purgeCache()">
                        ğŸ§¹ Purger cache navigateur
                    </button>
                </div>
            </div>

            <!-- Logs & Monitoring -->
            <div class="card">
                <h2>ğŸ“Š Logs & Monitoring</h2>
                <p>Surveillance en temps rÃ©el</p>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="showLogs()">
                        ğŸ“‹ Voir logs systÃ¨me
                    </button>
                    <button class="btn btn-info" onclick="showErrorLogs()">
                        âŒ Logs d'erreurs
                    </button>
                    <button class="btn btn-info" onclick="generateReport()">
                        ğŸ“Š GÃ©nÃ©rer rapport complet
                    </button>
                    <button class="btn btn-success" onclick="clearLogs()">
                        ğŸ§¹ Effacer logs
                    </button>
                </div>
            </div>

            <!-- GitHub & Versioning -->
            <div class="card">
                <h2>ğŸ™ GitHub & Versioning</h2>
                <p>Gestion du code source</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openGitHub()">
                        ğŸ™ Ouvrir Repository
                    </button>
                    <button class="btn btn-info" onclick="checkVersion()">
                        ğŸ“Œ Version actuelle
                    </button>
                    <button class="btn btn-info" onclick="showCommitHistory()">
                        ğŸ“œ Historique commits
                    </button>
                    <button class="btn btn-warning" onclick="createBackup()">
                        ğŸ’¾ CrÃ©er backup local
                    </button>
                </div>
            </div>

            <!-- Tests AvancÃ©s -->
            <div class="card">
                <h2>ğŸ§ª Tests AvancÃ©s</h2>
                <p>Tests de performance et intÃ©gritÃ©</p>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="performanceTest()">
                        âš¡ Test Performance
                    </button>
                    <button class="btn btn-info" onclick="integrityCheck()">
                        ğŸ” VÃ©rification IntÃ©gritÃ©
                    </button>
                    <button class="btn btn-info" onclick="loadTest()">
                        ğŸ“ˆ Test de Charge
                    </button>
                    <button class="btn btn-warning" onclick="stressTest()">
                        ğŸ’ª Stress Test
                    </button>
                </div>
            </div>

            <!-- Outils DÃ©veloppeur -->
            <div class="card">
                <h2>ğŸ‘¨â€ğŸ’» Outils DÃ©veloppeur</h2>
                <p>Debug et dÃ©veloppement</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openDevTools()">
                        ğŸ”§ Console DevTools
                    </button>
                    <button class="btn btn-primary" onclick="showFirebaseConfig()">
                        âš™ï¸ Config Firebase
                    </button>
                    <button class="btn btn-primary" onclick="showEnvironment()">
                        ğŸŒ Variables d'environnement
                    </button>
                    <button class="btn btn-primary" onclick="testAPI()">
                        ğŸ”Œ Test API Calls
                    </button>
                </div>
            </div>

            <!-- SÃ©curitÃ© -->
            <div class="card">
                <h2>ğŸ”’ SÃ©curitÃ©</h2>
                <p>Audit et sÃ©curitÃ©</p>
                <div class="btn-group">
                    <button class="btn btn-warning" onclick="securityAudit()">
                        ğŸ” Audit SÃ©curitÃ©
                    </button>
                    <button class="btn btn-warning" onclick="checkRules()">
                        ğŸ›¡ï¸ VÃ©rifier Rules
                    </button>
                    <button class="btn btn-danger" onclick="showDeletedAccess()">
                        ğŸ” Logs AccÃ¨s
                    </button>
                    <button class="btn btn-danger" onclick="forceLogoutAll()">
                        ğŸšª DÃ©connecter tout le monde
                    </button>
                </div>
            </div>

            <!-- Base de DonnÃ©es -->
            <div class="card">
                <h2>ğŸ’¾ Base de DonnÃ©es</h2>
                <p>Gestion Firestore</p>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="showCollections()">
                        ğŸ“š Voir toutes collections
                    </button>
                    <button class="btn btn-info" onclick="countDocuments()">
                        ğŸ”¢ Compter documents
                    </button>
                    <button class="btn btn-success" onclick="optimizeDatabase()">
                        âš¡ Optimiser base
                    </button>
                    <button class="btn btn-danger" onclick="showModal('dangerModal')">
                        âš ï¸ Zone Danger
                    </button>
                </div>
            </div>
        </div>

        <!-- Console de logs -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>ğŸ“Ÿ Console SystÃ¨me</h2>
            <div class="console" id="systemConsole">
                <div class="console-line info">âœ… SystÃ¨me initialisÃ© - PrÃªt Ã  l'emploi</div>
            </div>
        </div>
    </div>

    <!-- Modal RÃ©paration -->
    <div id="repairModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="repair-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="repair-modal-title"><span aria-hidden="true">ğŸ”§</span> RÃ©paration de Profils</h2>
                <button class="close-btn" onclick="closeModal('repairModal')" aria-label="Fermer la modale">&times;</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="repairMissingProfiles()">
                    ğŸ”§ RÃ©parer profils manquants
                </button>
                <button class="btn btn-success" onclick="repairPermissions()">
                    ğŸ”§ RÃ©parer permissions
                </button>
                <button class="btn btn-success" onclick="repairAdminProfile()">
                    ğŸ”§ RÃ©parer profil admin
                </button>
                <button class="btn btn-warning" onclick="forceRecreateProfile()">
                    âš ï¸ Forcer recrÃ©ation profil
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Import -->
    <div id="importModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="import-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="import-modal-title"><span aria-hidden="true">ğŸ“¥</span> Import de DonnÃ©es</h2>
                <button class="close-btn" onclick="closeModal('importModal')" aria-label="Fermer la modale">&times;</button>
            </div>
            <input type="file" id="importFile" accept=".json" style="margin-bottom: 20px; color: white;">
            <div class="btn-group">
                <button class="btn btn-success" onclick="importData()">
                    ğŸ“¥ Importer fichier
                </button>
                <button class="btn btn-warning" onclick="closeModal('importModal')">
                    âŒ Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Zone Danger -->
    <div id="dangerModal" class="modal" role="alertdialog" aria-modal="true" aria-labelledby="danger-modal-title" aria-describedby="danger-modal-desc">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="danger-modal-title"><span aria-hidden="true">âš ï¸</span> ZONE DANGER</h2>
                <button class="close-btn" onclick="closeModal('dangerModal')" aria-label="Fermer la modale">&times;</button>
            </div>
            <p id="danger-modal-desc" style="color: #ff6b6b; margin-bottom: 20px;"><span aria-hidden="true">âš ï¸</span> ATTENTION: Ces actions sont IRRÃ‰VERSIBLES!</p>
            <div class="btn-group">
                <button class="btn btn-danger" onclick="deleteAllUsers()">
                    ğŸ—‘ï¸ SUPPRIMER TOUS LES UTILISATEURS
                </button>
                <button class="btn btn-danger" onclick="deleteAllCasiers()">
                    ğŸ—‘ï¸ SUPPRIMER TOUS LES CASIERS
                </button>
                <button class="btn btn-danger" onclick="resetDatabase()">
                    âš ï¸ RESET COMPLET DATABASE
                </button>
                <button class="btn btn-warning" onclick="closeModal('dangerModal')">
                    âŒ Annuler
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, deleteDoc, setDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDMPBik5vpX8qOYWuhPzpJZoOLjE20pl6g",
            authDomain: "gestion-epi-4387a.firebaseapp.com",
            projectId: "gestion-epi-4387a",
            storageBucket: "gestion-epi-4387a.firebasestorage.app",
            messagingSenderId: "974706767408",
            appId: "1:974706767408:web:fde01e52a3a986d6da9ff5",
            measurementId: "G-PKNXH32P0Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.db = db;
        window.auth = auth;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ› ï¸ UTILITY FUNCTIONS (Code Quality Improvement)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Log une action administrateur critique pour audit
         * @param {string} action - Type d'action
         * @param {Object} details - DÃ©tails de l'action
         */
        function logAdminAction(action, details) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                admin: auth.currentUser ? auth.currentUser.email : 'unknown',
                details: details
            };
            console.log(`ğŸ” [ADMIN CRITICAL]`, logEntry);
            // Peut Ãªtre Ã©tendu pour sauvegarder dans Firestore
        }

        /**
         * Affiche un message d'erreur utilisateur
         * @param {string} message - Le message d'erreur
         */
        function showUserError(message) {
            console.error('âŒ', message);
            alert(message);
        }

        /**
         * Sanitize une chaÃ®ne de caractÃ¨res
         * @param {string} str - La chaÃ®ne Ã  nettoyer
         * @returns {string} ChaÃ®ne nettoyÃ©e
         */
        function sanitizeString(str) {
            if (!str || typeof str !== 'string') return '';
            return str.trim().replace(/\s+/g, ' ');
        }
        
        // ğŸš¨ VÃ‰RIFICATION ADMIN OBLIGATOIRE
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('â›” AccÃ¨s refusÃ© : Vous devez Ãªtre connectÃ©');
                window.location.href = 'index.html';
                return;
            }
            
            // VÃ©rifier le rÃ´le admin
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) {
                    console.error('â›” Profil introuvable pour UID:', user.uid, 'Email:', user.email);
                    alert('â›” AccÃ¨s refusÃ© : Profil utilisateur introuvable');
                    window.location.href = 'gestion-casiers.html';
                    return;
                }
                
                const userData = userDoc.data();
                console.log('ğŸ“‹ Profil chargÃ©:', userData);
                
                if (userData.role !== 'admin') {
                    alert('â›” AccÃ¨s refusÃ© : Cette page est rÃ©servÃ©e aux administrateurs');
                    window.location.href = 'gestion-casiers.html';
                    return;
                }
                
                // Admin vÃ©rifiÃ© - AccÃ¨s autorisÃ©
                document.getElementById('currentUser').textContent = user.email + ' (ADMIN)';
                addLog('âœ… Administrateur vÃ©rifiÃ©: ' + user.email, 'success');
                loadStats();
                
            } catch (error) {
                console.error('âŒ Erreur vÃ©rification admin:', error);
                alert('â›” Erreur de vÃ©rification des permissions: ' + error.message);
                window.location.href = 'gestion-casiers.html';
            }
        });

        // Console logging
        function addLog(message, type = 'info') {
            const console = document.getElementById('systemConsole');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            line.textContent = `[${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        window.addLog = addLog;
        window.showAlert = showAlert;

        // Modal management
        window.showModal = function(id) {
            document.getElementById(id).style.display = 'block';
        };

        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        };

        // Stats loading
        async function loadStats() {
            try {
                const usersSnap = await getDocs(collection(db, 'users'));
                document.getElementById('statUsers').textContent = usersSnap.size;

                const casiersSnap = await getDocs(collection(db, 'casiers'));
                document.getElementById('statCasiers').textContent = casiersSnap.size;

                const deletedSnap = await getDocs(collection(db, 'deleted_users'));
                document.getElementById('statDeleted').textContent = deletedSnap.size;

                document.getElementById('statAuth').innerHTML = 'âœ…<span class="badge online">OK</span>';
                document.getElementById('statFirestore').innerHTML = 'âœ…<span class="badge online">OK</span>';

                addLog('âœ… Statistiques chargÃ©es', 'success');
            } catch (error) {
                addLog('âŒ Erreur chargement stats: ' + error.message, 'error');
            }
        }

        // Firebase Console
        window.openFirebaseConsole = function() {
            window.open('https://console.firebase.google.com/project/gestion-epi-4387a/overview', '_blank');
            addLog('ğŸ”¥ Ouverture Console Firebase', 'info');
        };

        window.openFirebaseAuth = function() {
            window.open('https://console.firebase.google.com/project/gestion-epi-4387a/authentication/users', '_blank');
            addLog('ğŸ” Ouverture Authentication', 'info');
        };

        window.openFirebaseFirestore = function() {
            window.open('https://console.firebase.google.com/project/gestion-epi-4387a/firestore/databases/-default-/data', '_blank');
            addLog('ğŸ’¾ Ouverture Firestore', 'info');
        };

        window.openFirebaseRules = function() {
            window.open('https://console.firebase.google.com/project/gestion-epi-4387a/firestore/rules', '_blank');
            addLog('ğŸ›¡ï¸ Ouverture Security Rules', 'info');
        };

        // Scan users
        window.scanUsers = async function() {
            addLog('ğŸ” Scan des utilisateurs...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                let report = `\nğŸ“Š RAPPORT UTILISATEURS\n`;
                report += `Total: ${snapshot.size}\n\n`;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    report += `- ${data.email} (${data.role})\n`;
                });

                alert(report);
                addLog(`âœ… Scan terminÃ©: ${snapshot.size} utilisateurs`, 'success');
            } catch (error) {
                addLog('âŒ Erreur scan: ' + error.message, 'error');
            }
        };

        // Find orphans
        window.findOrphans = async function() {
            addLog('ğŸ” Recherche comptes orphelins...', 'info');
            try {
                const deletedSnap = await getDocs(collection(db, 'deleted_users'));
                if (deletedSnap.size === 0) {
                    showAlert('âœ… Aucun compte orphelin trouvÃ©', 'success');
                } else {
                    showAlert(`âš ï¸ ${deletedSnap.size} comptes orphelins trouvÃ©s (Auth existe, Firestore supprimÃ©)`, 'warning');
                }
                addLog(`ğŸ” ${deletedSnap.size} comptes orphelins`, 'warning');
            } catch (error) {
                addLog('âŒ Erreur: ' + error.message, 'error');
            }
        };

        // Check permissions
        window.checkPermissions = async function() {
            addLog('âœ… VÃ©rification permissions...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                let issues = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.role === 'utilisateur' && !data.permissions) {
                        issues++;
                    }
                });

                if (issues === 0) {
                    showAlert('âœ… Toutes les permissions sont correctes', 'success');
                } else {
                    showAlert(`âš ï¸ ${issues} utilisateurs avec permissions manquantes`, 'warning');
                }
                addLog(`âœ… VÃ©rification terminÃ©e: ${issues} problÃ¨mes`, issues > 0 ? 'warning' : 'success');
            } catch (error) {
                addLog('âŒ Erreur: ' + error.message, 'error');
            }
        };

        // Test Auth
        window.testAuth = async function() {
            addLog('ğŸ” Test Authentication...', 'info');
            try {
                if (auth.currentUser) {
                    showAlert(`âœ… Authentication OK - User: ${auth.currentUser.email}`, 'success');
                    addLog('âœ… Authentication fonctionnelle', 'success');
                } else {
                    showAlert('âŒ Aucun utilisateur connectÃ©', 'error');
                    addLog('âŒ Authentication: Non connectÃ©', 'error');
                }
            } catch (error) {
                addLog('âŒ Erreur: ' + error.message, 'error');
            }
        };

        // Test Firestore
        window.testFirestore = async function() {
            addLog('ğŸ’¾ Test Firestore...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                showAlert(`âœ… Firestore OK - ${snapshot.size} documents dans users`, 'success');
                addLog('âœ… Firestore fonctionnel', 'success');
            } catch (error) {
                showAlert('âŒ Erreur Firestore: ' + error.message, 'error');
                addLog('âŒ Firestore: ' + error.message, 'error');
            }
        };

        // Test Security Rules
        window.testSecurityRules = async function() {
            addLog('ğŸ›¡ï¸ Test Security Rules...', 'info');
            try {
                // Try to read
                await getDocs(collection(db, 'users'));
                addLog('âœ… Lecture autorisÃ©e', 'success');

                // Try to write
                const testDoc = doc(db, 'test', 'security_test');
                await setDoc(testDoc, { test: true, timestamp: new Date() });
                await deleteDoc(testDoc);
                
                showAlert('âœ… Security Rules: Lecture et Ã©criture OK', 'success');
                addLog('âœ… Security Rules fonctionnelles', 'success');
            } catch (error) {
                showAlert('âš ï¸ Security Rules restrictives: ' + error.message, 'warning');
                addLog('âš ï¸ Security Rules: ' + error.message, 'warning');
            }
        };

        // Test Complete Flow
        window.testCompleteFlow = async function() {
            addLog('ğŸ¯ Test flux complet...', 'info');
            await testAuth();
            await new Promise(r => setTimeout(r, 500));
            await testFirestore();
            await new Promise(r => setTimeout(r, 500));
            await testSecurityRules();
            showAlert('âœ… Tests complets terminÃ©s - Voir console', 'success');
        };

        // Export functions
        window.exportUsers = async function() {
            addLog('ğŸ“¤ Export utilisateurs...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                const blob = new Blob([JSON.stringify(users, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users_export_${new Date().toISOString()}.json`;
                a.click();
                
                showAlert(`âœ… ${users.length} utilisateurs exportÃ©s`, 'success');
                addLog(`âœ… Export: ${users.length} utilisateurs`, 'success');
            } catch (error) {
                addLog('âŒ Erreur: ' + error.message, 'error');
            }
        };

        window.exportCasiers = async function() {
            addLog('ğŸ“¤ Export casiers...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'casiers'));
                const casiers = [];
                snapshot.forEach(doc => {
                    casiers.push({ id: doc.id, ...doc.data() });
                });

                const blob = new Blob([JSON.stringify(casiers, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `casiers_export_${new Date().toISOString()}.json`;
                a.click();
                
                showAlert(`âœ… ${casiers.length} casiers exportÃ©s`, 'success');
                addLog(`âœ… Export: ${casiers.length} casiers`, 'success');
            } catch (error) {
                addLog('âŒ Erreur: ' + error.message, 'error');
            }
        };

        window.exportAll = async function() {
            addLog('ğŸ“¤ Export complet...', 'info');
            await exportUsers();
            await new Promise(r => setTimeout(r, 500));
            await exportCasiers();
        };

        // Clean functions
        window.cleanDeletedUsers = async function() {
            const confirm = prompt('ğŸ§¹ Nettoyer toutes les traces de suppression?\nTapez: NETTOYER');
            if (confirm !== 'NETTOYER') return;

            addLog('ğŸ§¹ Nettoyage traces...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'deleted_users'));
                let count = 0;
                for (const docSnap of snapshot.docs) {
                    await deleteDoc(doc(db, 'deleted_users', docSnap.id));
                    count++;
                }
                showAlert(`âœ… ${count} traces nettoyÃ©es`, 'success');
                addLog(`âœ… ${count} traces supprimÃ©es`, 'success');
                loadStats();
            } catch (error) {
                addLog('âŒ Erreur: ' + error.message, 'error');
            }
        };

        window.purgeCache = function() {
            addLog('ğŸ§¹ Purge cache...', 'info');
            localStorage.clear();
            sessionStorage.clear();
            showAlert('âœ… Cache purgÃ© - Rechargez la page', 'success');
            addLog('âœ… Cache purgÃ©', 'success');
        };

        // GitHub
        window.openGitHub = function() {
            const repo = prompt('ğŸ™ Entrez l\'URL du repository GitHub:');
            if (repo) {
                window.open(repo, '_blank');
                addLog('ğŸ™ Ouverture GitHub', 'info');
            }
        };

        window.checkVersion = function() {
            const version = '1.0.0'; // Ã€ mettre Ã  jour
            alert(`ğŸ“Œ Version: ${version}\nDate: ${new Date().toLocaleDateString('fr-FR')}`);
            addLog(`ğŸ“Œ Version: ${version}`, 'info');
        };

        window.createBackup = function() {
            addLog('ğŸ’¾ CrÃ©ation backup...', 'info');
            showAlert('ğŸ’¾ Backup local crÃ©Ã© (export JSON)', 'info');
            exportAll();
        };

        // Dev tools
        window.openDevTools = function() {
            addLog('ğŸ”§ Ouvrez F12 pour DevTools', 'info');
            showAlert('ğŸ”§ Appuyez sur F12 pour ouvrir DevTools', 'info');
        };

        window.showFirebaseConfig = function() {
            const config = JSON.stringify(firebaseConfig, null, 2);
            alert(`âš™ï¸ FIREBASE CONFIG:\n\n${config}`);
            addLog('âš™ï¸ Config affichÃ©e', 'info');
        };

        window.showEnvironment = function() {
            const env = {
                browser: navigator.userAgent,
                url: window.location.href,
                online: navigator.onLine,
                language: navigator.language
            };
            alert(`ğŸŒ ENVIRONNEMENT:\n\n${JSON.stringify(env, null, 2)}`);
            addLog('ğŸŒ Environment affichÃ©', 'info');
        };

        // Database
        window.showCollections = async function() {
            addLog('ğŸ“š Collections disponibles:', 'info');
            const collections = ['users', 'casiers', 'deleted_users', 'test'];
            alert(`ğŸ“š COLLECTIONS FIRESTORE:\n\n${collections.join('\n')}`);
            collections.forEach(col => addLog(`  - ${col}`, 'info'));
        };

        window.countDocuments = async function() {
            addLog('ğŸ”¢ Comptage documents...', 'info');
            try {
                const users = await getDocs(collection(db, 'users'));
                const casiers = await getDocs(collection(db, 'casiers'));
                const deleted = await getDocs(collection(db, 'deleted_users'));

                const report = `ğŸ“Š DOCUMENTS:\n\nusers: ${users.size}\ncasiers: ${casiers.size}\ndeleted_users: ${deleted.size}`;
                alert(report);
                addLog('âœ… Comptage terminÃ©', 'success');
            } catch (error) {
                addLog('âŒ Erreur: ' + error.message, 'error');
            }
        };

        // Security
        window.securityAudit = async function() {
            addLog('ğŸ” Audit sÃ©curitÃ©...', 'info');
            showAlert('ğŸ” Audit en cours...', 'info');
            
            setTimeout(() => {
                const report = `
ğŸ”’ AUDIT SÃ‰CURITÃ‰

âœ… Firebase Authentication: OK
âœ… Firestore connexion: OK
âš ï¸ Security Rules: Mode dÃ©veloppement (ouvert)
âœ… HTTPS: ${window.location.protocol === 'https:' ? 'OK' : 'NON (fichier local)'}

RECOMMANDATIONS:
- Activer Security Rules en production
- Utiliser HTTPS en production
- Limiter les permissions des utilisateurs
                `;
                alert(report);
                addLog('âœ… Audit terminÃ©', 'success');
            }, 2000);
        };

        // Repair functions
        window.repairMissingProfiles = async function() {
            addLog('ğŸ”§ RÃ©paration profils...', 'info');
            showAlert('ğŸ”§ Utilisez nettoyage-complet.html pour rÃ©parer', 'info');
        };

        window.repairAdminProfile = function() {
            window.location.href = 'fix-profile.html';
        };

        // Performance test
        window.performanceTest = async function() {
            addLog('âš¡ Test performance...', 'info');
            const start = performance.now();
            
            try {
                await getDocs(collection(db, 'users'));
                const end = performance.now();
                const time = (end - start).toFixed(2);
                
                showAlert(`âš¡ Performance: ${time}ms`, time < 1000 ? 'success' : 'warning');
                addLog(`âš¡ Temps de rÃ©ponse: ${time}ms`, time < 1000 ? 'success' : 'warning');
            } catch (error) {
                addLog('âŒ Erreur: ' + error.message, 'error');
            }
        };

        window.integrityCheck = async function() {
            addLog('ğŸ” VÃ©rification intÃ©gritÃ©...', 'info');
            await checkPermissions();
            await findOrphans();
            showAlert('âœ… VÃ©rification terminÃ©e', 'success');
        };

        // Generate report
        window.generateReport = async function() {
            addLog('ğŸ“Š GÃ©nÃ©ration rapport...', 'info');
            
            try {
                const users = await getDocs(collection(db, 'users'));
                const casiers = await getDocs(collection(db, 'casiers'));
                const deleted = await getDocs(collection(db, 'deleted_users'));

                const report = {
                    date: new Date().toISOString(),
                    stats: {
                        users: users.size,
                        casiers: casiers.size,
                        deleted: deleted.size
                    },
                    users: [],
                    casiers: []
                };

                users.forEach(doc => report.users.push({ id: doc.id, ...doc.data() }));
                casiers.forEach(doc => report.casiers.push({ id: doc.id, ...doc.data() }));

                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rapport_complet_${new Date().toISOString()}.json`;
                a.click();

                showAlert('âœ… Rapport gÃ©nÃ©rÃ© et tÃ©lÃ©chargÃ©', 'success');
                addLog('âœ… Rapport crÃ©Ã©', 'success');
            } catch (error) {
                addLog('âŒ Erreur: ' + error.message, 'error');
            }
        };

        // Clear logs
        window.clearLogs = function() {
            document.getElementById('systemConsole').innerHTML = '<div class="console-line info">âœ… Logs effacÃ©s</div>';
            addLog('âœ… SystÃ¨me prÃªt', 'success');
        };

        // Show logs
        window.showLogs = function() {
            addLog('ğŸ“‹ Tous les logs sont affichÃ©s dans la console ci-dessous', 'info');
        };

        window.showErrorLogs = function() {
            addLog('âŒ Fonction en dÃ©veloppement', 'warning');
        };

        // Init
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('currentUser').textContent = user.email;
                addLog(`âœ… ConnectÃ©: ${user.email}`, 'success');
                loadStats();
            } else {
                document.getElementById('currentUser').innerHTML = '<span style="color: #ff6b6b;">Non connectÃ©</span>';
                addLog('âš ï¸ Non connectÃ©', 'warning');
                setTimeout(() => {
                    if (confirm('Vous devez Ãªtre connectÃ©. Redirection vers index.html?')) {
                        window.location.href = 'index.html';
                    }
                }, 2000);
            }
        });

        addLog('ğŸš€ Admin Administrator initialisÃ©', 'success');
    </script>
</body>
</html>
