<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tools - Gestion PPVE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }

        .header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            opacity: 0.9;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .warning-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .warning-banner h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .tool-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }

        .tool-card h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .tool-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .tool-card.danger {
            border-left-color: #dc3545;
        }

        .btn-tool {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            margin-top: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .info-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .info-section h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #333;
        }

        .info-value {
            color: #666;
        }

        .logs {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-error {
            color: #f48771;
        }

        .log-success {
            color: #89d185;
        }

        .log-info {
            color: #4fc1ff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ†Ô∏è Admin Tools - Centre de Contr√¥le</h1>
        <div class="header-right">
            <div class="user-info">
                <div class="user-name" id="userName">Chargement...</div>
                <div class="user-role" id="userRole"></div>
            </div>
            <button class="btn btn-secondary" onclick="window.location.href='gestion-casiers.html'">üîí Casiers</button>
            <button class="btn btn-secondary" onclick="window.location.href='Antho.html'">üì¶ √âquipements</button>
            <button class="btn btn-secondary" onclick="window.location.href='admin-test.html'">üë• Utilisateurs</button>
            <button class="btn btn-danger" onclick="logout()">D√©connexion</button>
        </div>
    </div>

    <div class="container">
        <div class="warning-banner">
            <h2>‚ö†Ô∏è Zone Administrateur</h2>
            <p>Ces outils sont r√©serv√©s aux administrateurs. Utilisez-les avec pr√©caution.</p>
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <div class="info-section">
            <h3>üìä Informations Syst√®me</h3>
            <div class="info-item">
                <span class="info-label">Projet Firebase:</span>
                <span class="info-value">gestion-epi-4387a</span>
            </div>
            <div class="info-item">
                <span class="info-label">Version Application:</span>
                <span class="info-value">2.0.0</span>
            </div>
            <div class="info-item">
                <span class="info-label">Total Utilisateurs:</span>
                <span class="info-value" id="totalUsers">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Total Casiers:</span>
                <span class="info-value">288</span>
            </div>
            <div class="info-item">
                <span class="info-label">Total √âquipements:</span>
                <span class="info-value" id="totalEquipments">-</span>
            </div>
        </div>

        <div class="tools-grid">
            <div class="tool-card">
                <h3>üîç Diagnostic Firebase</h3>
                <p>V√©rifiez la connexion √† Firebase et l'√©tat de la base de donn√©es.</p>
                <button class="btn btn-primary btn-tool" onclick="runDiagnostic()">Lancer le diagnostic</button>
            </div>

            <div class="tool-card">
                <h3>üìà Statistiques</h3>
                <p>Consultez les statistiques d√©taill√©es de l'application.</p>
                <button class="btn btn-primary btn-tool" onclick="showStats()">Afficher les stats</button>
            </div>

            <div class="tool-card">
                <h3>üîÑ Actualiser les donn√©es</h3>
                <p>Rechargez toutes les donn√©es depuis Firebase.</p>
                <button class="btn btn-primary btn-tool" onclick="refreshData()">Actualiser</button>
            </div>

            <div class="tool-card">
                <h3>üì• Export JSON</h3>
                <p>Exportez toutes les donn√©es au format JSON.</p>
                <button class="btn btn-primary btn-tool" onclick="exportData()">Exporter</button>
            </div>

            <div class="tool-card danger">
                <h3>üóëÔ∏è Nettoyage Complet</h3>
                <p>Nettoyez les donn√©es obsol√®tes (ATTENTION : irr√©versible).</p>
                <button class="btn btn-warning btn-tool" onclick="window.location.href='nettoyage-complet.html'">Acc√©der</button>
            </div>

            <div class="tool-card danger">
                <h3>‚ö° R√©initialiser Admin</h3>
                <p>R√©initialise le compte administrateur principal.</p>
                <button class="btn btn-danger btn-tool" onclick="window.location.href='reset-admin.html'">R√©initialiser</button>
            </div>
        </div>

        <div class="info-section">
            <h3>üìú Logs Syst√®me</h3>
            <div class="logs" id="logsContainer">
                <div class="log-entry log-info">[INFO] Syst√®me initialis√©</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDMPBik5vpX8qOYWuhPzpJZoOLjE20pl6g",
            authDomain: "gestion-epi-4387a.firebaseapp.com",
            projectId: "gestion-epi-4387a",
            storageBucket: "gestion-epi-4387a.firebasestorage.app",
            messagingSenderId: "974706767408",
            appId: "1:974706767408:web:fde01e52a3a986d6da9ff5",
            measurementId: "G-PKNXH32P0Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        window.logout = async function() {
            if (confirm('Voulez-vous vraiment vous d√©connecter?')) {
                await signOut(auth);
                window.location.href = 'index.html';
            }
        };

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logsContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists() || !userDoc.data().active) {
                    await signOut(auth);
                    window.location.href = 'index.html';
                    return;
                }

                currentUser = { uid: user.uid, ...userDoc.data() };
                document.getElementById('userName').textContent = currentUser.name || user.email;
                document.getElementById('userRole').textContent = currentUser.role || 'Utilisateur';

                if (currentUser.role !== 'admin' && currentUser.role !== 'superadmin') {
                    showError('Acc√®s non autoris√©');
                    addLog('Tentative d\'acc√®s non autoris√©e', 'error');
                    setTimeout(() => window.location.href = 'gestion-casiers.html', 2000);
                    return;
                }

                addLog('Connexion administrateur r√©ussie', 'success');
                await loadSystemInfo();
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de chargement des donn√©es');
                addLog('Erreur de chargement: ' + error.message, 'error');
            }
        });

        async function loadSystemInfo() {
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                document.getElementById('totalUsers').textContent = usersSnapshot.size;

                const equipmentsSnapshot = await getDocs(collection(db, 'equipements'));
                document.getElementById('totalEquipments').textContent = equipmentsSnapshot.size;

                addLog('Statistiques syst√®me charg√©es', 'success');
            } catch (error) {
                console.error('Erreur chargement stats:', error);
                addLog('Erreur chargement stats: ' + error.message, 'error');
            }
        }

        window.runDiagnostic = async function() {
            addLog('D√©but du diagnostic...', 'info');
            
            try {
                addLog('V√©rification connexion Firebase...', 'info');
                await new Promise(resolve => setTimeout(resolve, 500));
                addLog('‚úì Connexion Firebase OK', 'success');

                addLog('V√©rification collection users...', 'info');
                const usersSnapshot = await getDocs(collection(db, 'users'));
                addLog(`‚úì Collection users: ${usersSnapshot.size} documents`, 'success');

                addLog('V√©rification collection casiers...', 'info');
                const casiersDoc = await getDoc(doc(db, 'casiers', 'data'));
                addLog(`‚úì Collection casiers: ${casiersDoc.exists() ? 'OK' : 'Vide'}`, 'success');

                addLog('V√©rification collection √©quipements...', 'info');
                const equipmentsSnapshot = await getDocs(collection(db, 'equipements'));
                addLog(`‚úì Collection √©quipements: ${equipmentsSnapshot.size} documents`, 'success');

                addLog('Diagnostic termin√© avec succ√®s', 'success');
                showSuccess('Diagnostic termin√© - Tous les syst√®mes op√©rationnels');
            } catch (error) {
                addLog('‚úó Erreur diagnostic: ' + error.message, 'error');
                showError('Erreur lors du diagnostic');
            }
        };

        window.showStats = async function() {
            addLog('Calcul des statistiques...', 'info');
            
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = [];
                usersSnapshot.forEach(doc => users.push(doc.data()));

                const activeUsers = users.filter(u => u.active).length;
                const admins = users.filter(u => u.role === 'admin' || u.role === 'superadmin').length;

                addLog(`Total utilisateurs: ${users.length}`, 'info');
                addLog(`Utilisateurs actifs: ${activeUsers}`, 'info');
                addLog(`Administrateurs: ${admins}`, 'info');

                const casiersDoc = await getDoc(doc(db, 'casiers', 'data'));
                if (casiersDoc.exists()) {
                    const casiers = casiersDoc.data();
                    const occupied = Object.values(casiers).filter(c => c.occupied).length;
                    addLog(`Casiers occup√©s: ${occupied}/288`, 'info');
                }

                const equipmentsSnapshot = await getDocs(collection(db, 'equipements'));
                const equipments = [];
                equipmentsSnapshot.forEach(doc => equipments.push(doc.data()));
                const available = equipments.filter(e => e.status === 'disponible').length;
                addLog(`√âquipements disponibles: ${available}/${equipments.length}`, 'info');

                showSuccess('Statistiques affich√©es dans les logs');
            } catch (error) {
                addLog('Erreur calcul stats: ' + error.message, 'error');
                showError('Erreur lors du calcul des statistiques');
            }
        };

        window.refreshData = async function() {
            addLog('Actualisation des donn√©es...', 'info');
            await loadSystemInfo();
            showSuccess('Donn√©es actualis√©es');
        };

        window.exportData = async function() {
            addLog('Export des donn√©es...', 'info');
            
            try {
                const data = {
                    exportDate: new Date().toISOString(),
                    users: [],
                    casiers: {},
                    equipements: []
                };

                const usersSnapshot = await getDocs(collection(db, 'users'));
                usersSnapshot.forEach(doc => data.users.push({ id: doc.id, ...doc.data() }));

                const casiersDoc = await getDoc(doc(db, 'casiers', 'data'));
                if (casiersDoc.exists()) {
                    data.casiers = casiersDoc.data();
                }

                const equipmentsSnapshot = await getDocs(collection(db, 'equipements'));
                equipmentsSnapshot.forEach(doc => data.equipements.push({ id: doc.id, ...doc.data() }));

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `export_gestion_ppve_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                addLog('Export termin√© avec succ√®s', 'success');
                showSuccess('Donn√©es export√©es avec succ√®s');
            } catch (error) {
                addLog('Erreur export: ' + error.message, 'error');
                showError('Erreur lors de l\'export');
            }
        };

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }
    </script>
</body>
</html>
