<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Admin Administrator - Debug & Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #ff0080 0%, #7928ca 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(255, 0, 128, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: white;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
        }

        .card:hover {
            border-color: #ff0080;
            box-shadow: 0 6px 30px rgba(255, 0, 128, 0.2);
            transform: translateY(-2px);
        }

        .card h2 {
            color: #ff0080;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
        }

        .card p {
            color: #999;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(86, 171, 47, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
            color: #333;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(242, 153, 74, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(33, 147, 176, 0.4);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 1px solid #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-box:hover {
            border-color: #ff0080;
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #ff0080;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #999;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid;
        }

        .alert.success {
            background: rgba(86, 171, 47, 0.2);
            color: #a8e063;
            border-color: #56ab2f;
        }

        .alert.error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border-color: #ee5a52;
        }

        .alert.warning {
            background: rgba(242, 153, 74, 0.2);
            color: #f2994a;
            border-color: #f2c94c;
        }

        .alert.info {
            background: rgba(33, 147, 176, 0.2);
            color: #6dd5ed;
            border-color: #2193b0;
        }

        .console {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .console-line {
            padding: 5px 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .console-line.success { color: #56ab2f; }
        .console-line.error { color: #ff6b6b; }
        .console-line.warning { color: #f2994a; }
        .console-line.info { color: #6dd5ed; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 15px;
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #ff0080;
        }

        .close-btn {
            background: #333;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 5px;
        }

        .close-btn:hover {
            background: #ff0080;
        }

        pre {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            color: #a8e063;
        }

        .link-box {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .link-box a {
            color: #6dd5ed;
            text-decoration: none;
            display: block;
            padding: 8px 0;
            transition: all 0.3s;
        }

        .link-box a:hover {
            color: #ff0080;
            padding-left: 10px;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge.online {
            background: rgba(86, 171, 47, 0.3);
            color: #a8e063;
        }

        .badge.offline {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #ff0080;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üîß Admin Administrator</h1>
                    <p>Centre de contr√¥le et debug - Acc√®s complet au syst√®me</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">Connect√©: <span id="currentUser">Chargement...</span></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="location.href='admin-test.html'" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;">
                        üë§ Gestion Utilisateurs
                    </button>
                    <button onclick="location.href='gestion-casiers.html'" style="padding: 12px 24px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4); transition: all 0.3s;">
                        üè† Retour Application
                    </button>
                </div>
            </div>
        </div>

        <div id="alertBox" class="alert"></div>

        <!-- Statistiques -->
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="statUsers">-</div>
                <div class="stat-label">Utilisateurs</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statCasiers">-</div>
                <div class="stat-label">Casiers</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statDeleted">-</div>
                <div class="stat-label">Supprim√©s</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statAuth">-</div>
                <div class="stat-label">Auth Status</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statFirestore">-</div>
                <div class="stat-label">Firestore Status</div>
            </div>
        </div>

        <!-- Outils principaux -->
        <div class="grid">
            <!-- Navigation rapide -->
            <div class="card">
                <h2>üöÄ Navigation Rapide</h2>
                <p>Acc√®s direct aux diff√©rentes interfaces</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="window.location.href='admin-test.html'">
                        üë• Gestion Utilisateurs
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='gestion-casiers.html'">
                        üì¶ Gestion Casiers
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='nettoyage-complet.html'">
                        üßπ Nettoyage Complet
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='index.html'">
                        üè† Accueil
                    </button>
                </div>
            </div>

            <!-- Firebase Console -->
            <div class="card">
                <h2>üî• Firebase Console</h2>
                <p>Acc√®s direct √† Firebase</p>
                <div class="btn-group">
                    <button class="btn btn-warning" onclick="openFirebaseConsole()">
                        üî• Console Firebase
                    </button>
                    <button class="btn btn-warning" onclick="openFirebaseAuth()">
                        üîê Authentication
                    </button>
                    <button class="btn btn-warning" onclick="openFirebaseFirestore()">
                        üíæ Firestore Database
                    </button>
                    <button class="btn btn-warning" onclick="openFirebaseRules()">
                        üõ°Ô∏è Security Rules
                    </button>
                </div>
            </div>

            <!-- Debug Utilisateurs -->
            <div class="card">
                <h2>üë§ Debug Utilisateurs</h2>
                <p>Outils de diagnostic et r√©paration</p>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="scanUsers()">
                        üîç Scanner tous les utilisateurs
                    </button>
                    <button class="btn btn-success" onclick="findOrphans()">
                        üîç Trouver comptes orphelins
                    </button>
                    <button class="btn btn-success" onclick="checkPermissions()">
                        ‚úÖ V√©rifier permissions
                    </button>
                    <button class="btn btn-danger" onclick="showModal('repairModal')">
                        üîß R√©parer profils
                    </button>
                </div>
            </div>

            <!-- Tests Connexion -->
            <div class="card">
                <h2>üîå Tests Connexion</h2>
                <p>Tester les connexions Firebase</p>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="testAuth()">
                        üîê Test Authentication
                    </button>
                    <button class="btn btn-info" onclick="testFirestore()">
                        üíæ Test Firestore
                    </button>
                    <button class="btn btn-info" onclick="testSecurityRules()">
                        üõ°Ô∏è Test Security Rules
                    </button>
                    <button class="btn btn-info" onclick="testCompleteFlow()">
                        üéØ Test Flux Complet
                    </button>
                </div>
            </div>

            <!-- Export/Import -->
            <div class="card">
                <h2>üíæ Export / Import</h2>
                <p>Sauvegarde et restauration des donn√©es</p>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportUsers()">
                        üì§ Export Utilisateurs (JSON)
                    </button>
                    <button class="btn btn-success" onclick="exportCasiers()">
                        üì§ Export Casiers (JSON)
                    </button>
                    <button class="btn btn-success" onclick="exportAll()">
                        üì§ Export Complet
                    </button>
                    <button class="btn btn-warning" onclick="showModal('importModal')">
                        üì• Import Donn√©es
                    </button>
                </div>
            </div>

            <!-- Nettoyage -->
            <div class="card">
                <h2>üßπ Nettoyage</h2>
                <p>Nettoyer les donn√©es obsol√®tes</p>
                <div class="btn-group">
                    <button class="btn btn-danger" onclick="cleanDeletedUsers()">
                        üóëÔ∏è Nettoyer traces suppression
                    </button>
                    <button class="btn btn-danger" onclick="cleanOrphanData()">
                        üóëÔ∏è Nettoyer donn√©es orphelines
                    </button>
                    <button class="btn btn-danger" onclick="resetTestData()">
                        ‚ö†Ô∏è Reset donn√©es de test
                    </button>
                    <button class="btn btn-danger" onclick="purgeCache()">
                        üßπ Purger cache navigateur
                    </button>
                </div>
            </div>

            <!-- Logs & Monitoring -->
            <div class="card">
                <h2>üìä Logs & Monitoring</h2>
                <p>Surveillance en temps r√©el</p>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="showLogs()">
                        üìã Voir logs syst√®me
                    </button>
                    <button class="btn btn-info" onclick="showErrorLogs()">
                        ‚ùå Logs d'erreurs
                    </button>
                    <button class="btn btn-info" onclick="generateReport()">
                        üìä G√©n√©rer rapport complet
                    </button>
                    <button class="btn btn-success" onclick="clearLogs()">
                        üßπ Effacer logs
                    </button>
                </div>
            </div>

            <!-- GitHub & Versioning -->
            <div class="card">
                <h2>üêô GitHub & Versioning</h2>
                <p>Gestion du code source</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openGitHub()">
                        üêô Ouvrir Repository
                    </button>
                    <button class="btn btn-info" onclick="checkVersion()">
                        üìå Version actuelle
                    </button>
                    <button class="btn btn-info" onclick="showCommitHistory()">
                        üìú Historique commits
                    </button>
                    <button class="btn btn-warning" onclick="createBackup()">
                        üíæ Cr√©er backup local
                    </button>
                </div>
            </div>

            <!-- Tests Avanc√©s -->
            <div class="card">
                <h2>üß™ Tests Avanc√©s</h2>
                <p>Tests de performance et int√©grit√©</p>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="performanceTest()">
                        ‚ö° Test Performance
                    </button>
                    <button class="btn btn-info" onclick="integrityCheck()">
                        üîç V√©rification Int√©grit√©
                    </button>
                    <button class="btn btn-info" onclick="loadTest()">
                        üìà Test de Charge
                    </button>
                    <button class="btn btn-warning" onclick="stressTest()">
                        üí™ Stress Test
                    </button>
                </div>
            </div>

            <!-- Outils D√©veloppeur -->
            <div class="card">
                <h2>üë®‚Äçüíª Outils D√©veloppeur</h2>
                <p>Debug et d√©veloppement</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openDevTools()">
                        üîß Console DevTools
                    </button>
                    <button class="btn btn-primary" onclick="showFirebaseConfig()">
                        ‚öôÔ∏è Config Firebase
                    </button>
                    <button class="btn btn-primary" onclick="showEnvironment()">
                        üåç Variables d'environnement
                    </button>
                    <button class="btn btn-primary" onclick="testAPI()">
                        üîå Test API Calls
                    </button>
                </div>
            </div>

            <!-- S√©curit√© -->
            <div class="card">
                <h2>üîí S√©curit√©</h2>
                <p>Audit et s√©curit√©</p>
                <div class="btn-group">
                    <button class="btn btn-warning" onclick="securityAudit()">
                        üîç Audit S√©curit√©
                    </button>
                    <button class="btn btn-warning" onclick="checkRules()">
                        üõ°Ô∏è V√©rifier Rules
                    </button>
                    <button class="btn btn-danger" onclick="showDeletedAccess()">
                        üîê Logs Acc√®s
                    </button>
                    <button class="btn btn-danger" onclick="forceLogoutAll()">
                        üö™ D√©connecter tout le monde
                    </button>
                </div>
            </div>

            <!-- Base de Donn√©es -->
            <div class="card">
                <h2>üíæ Base de Donn√©es</h2>
                <p>Gestion Firestore</p>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="showCollections()">
                        üìö Voir toutes collections
                    </button>
                    <button class="btn btn-info" onclick="countDocuments()">
                        üî¢ Compter documents
                    </button>
                    <button class="btn btn-success" onclick="optimizeDatabase()">
                        ‚ö° Optimiser base
                    </button>
                    <button class="btn btn-danger" onclick="showModal('dangerModal')">
                        ‚ö†Ô∏è Zone Danger
                    </button>
                </div>
            </div>
        </div>

        <!-- Console de logs -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>üìü Console Syst√®me</h2>
            <div class="console" id="systemConsole">
                <div class="console-line info">‚úÖ Syst√®me initialis√© - Pr√™t √† l'emploi</div>
            </div>
        </div>
    </div>

    <!-- Modal R√©paration -->
    <div id="repairModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîß R√©paration de Profils</h2>
                <button class="close-btn" onclick="closeModal('repairModal')">&times;</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="repairMissingProfiles()">
                    üîß R√©parer profils manquants
                </button>
                <button class="btn btn-success" onclick="repairPermissions()">
                    üîß R√©parer permissions
                </button>
                <button class="btn btn-success" onclick="repairAdminProfile()">
                    üîß R√©parer profil admin
                </button>
                <button class="btn btn-warning" onclick="forceRecreateProfile()">
                    ‚ö†Ô∏è Forcer recr√©ation profil
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Import -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì• Import de Donn√©es</h2>
                <button class="close-btn" onclick="closeModal('importModal')">&times;</button>
            </div>
            <input type="file" id="importFile" accept=".json" style="margin-bottom: 20px; color: white;">
            <div class="btn-group">
                <button class="btn btn-success" onclick="importData()">
                    üì• Importer fichier
                </button>
                <button class="btn btn-warning" onclick="closeModal('importModal')">
                    ‚ùå Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Zone Danger -->
    <div id="dangerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è ZONE DANGER</h2>
                <button class="close-btn" onclick="closeModal('dangerModal')">&times;</button>
            </div>
            <p style="color: #ff6b6b; margin-bottom: 20px;">‚ö†Ô∏è ATTENTION: Ces actions sont IRR√âVERSIBLES!</p>
            <div class="btn-group">
                <button class="btn btn-danger" onclick="deleteAllUsers()">
                    üóëÔ∏è SUPPRIMER TOUS LES UTILISATEURS
                </button>
                <button class="btn btn-danger" onclick="deleteAllCasiers()">
                    üóëÔ∏è SUPPRIMER TOUS LES CASIERS
                </button>
                <button class="btn btn-danger" onclick="resetDatabase()">
                    ‚ö†Ô∏è RESET COMPLET DATABASE
                </button>
                <button class="btn btn-warning" onclick="closeModal('dangerModal')">
                    ‚ùå Annuler
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, deleteDoc, setDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDMPBik5vpX8qOYWuhPzpJZoOLjE20pl6g",
            authDomain: "gestion-epi-4387a.firebaseapp.com",
            projectId: "gestion-epi-4387a",
            storageBucket: "gestion-epi-4387a.firebasestorage.app",
            messagingSenderId: "974706767408",
            appId: "1:974706767408:web:fde01e52a3a986d6da9ff5",
            measurementId: "G-PKNXH32P0Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.db = db;
        window.auth = auth;
        
        // üö® V√âRIFICATION ADMIN OBLIGATOIRE
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('‚õî Acc√®s refus√© : Vous devez √™tre connect√©');
                window.location.href = 'index.html';
                return;
            }
            
            // V√©rifier le r√¥le admin
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) {
                    console.error('‚õî Profil introuvable pour UID:', user.uid, 'Email:', user.email);
                    alert('‚õî Acc√®s refus√© : Profil utilisateur introuvable');
                    window.location.href = 'gestion-casiers.html';
                    return;
                }
                
                const userData = userDoc.data();
                console.log('üìã Profil charg√©:', userData);
                
                if (userData.role !== 'admin') {
                    alert('‚õî Acc√®s refus√© : Cette page est r√©serv√©e aux administrateurs');
                    window.location.href = 'gestion-casiers.html';
                    return;
                }
                
                // Admin v√©rifi√© - Acc√®s autoris√©
                document.getElementById('currentUser').textContent = user.email + ' (ADMIN)';
                addLog('‚úÖ Administrateur v√©rifi√©: ' + user.email, 'success');
                loadStats();
                
            } catch (error) {
                console.error('‚ùå Erreur v√©rification admin:', error);
                alert('‚õî Erreur de v√©rification des permissions: ' + error.message);
                window.location.href = 'gestion-casiers.html';
            }
        });

        // Console logging
        function addLog(message, type = 'info') {
            const console = document.getElementById('systemConsole');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            line.textContent = `[${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert ${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        window.addLog = addLog;
        window.showAlert = showAlert;

        // Modal management
        window.showModal = function(id) {
            document.getElementById(id).style.display = 'block';
        };

        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        };

        // Stats loading
        async function loadStats() {
            try {
                const usersSnap = await getDocs(collection(db, 'users'));
                document.getElementById('statUsers').textContent = usersSnap.size;

                const casiersSnap = await getDocs(collection(db, 'casiers'));
                document.getElementById('statCasiers').textContent = casiersSnap.size;

                const deletedSnap = await getDocs(collection(db, 'deleted_users'));
                document.getElementById('statDeleted').textContent = deletedSnap.size;

                document.getElementById('statAuth').innerHTML = '‚úÖ<span class="badge online">OK</span>';
                document.getElementById('statFirestore').innerHTML = '‚úÖ<span class="badge online">OK</span>';

                addLog('‚úÖ Statistiques charg√©es', 'success');
            } catch (error) {
                addLog('‚ùå Erreur chargement stats: ' + error.message, 'error');
            }
        }

        // Firebase Console
        window.openFirebaseConsole = function() {
            window.open('https://console.firebase.google.com/project/gestion-epi-4387a/overview', '_blank');
            addLog('üî• Ouverture Console Firebase', 'info');
        };

        window.openFirebaseAuth = function() {
            window.open('https://console.firebase.google.com/project/gestion-epi-4387a/authentication/users', '_blank');
            addLog('üîê Ouverture Authentication', 'info');
        };

        window.openFirebaseFirestore = function() {
            window.open('https://console.firebase.google.com/project/gestion-epi-4387a/firestore/databases/-default-/data', '_blank');
            addLog('üíæ Ouverture Firestore', 'info');
        };

        window.openFirebaseRules = function() {
            window.open('https://console.firebase.google.com/project/gestion-epi-4387a/firestore/rules', '_blank');
            addLog('üõ°Ô∏è Ouverture Security Rules', 'info');
        };

        // Scan users
        window.scanUsers = async function() {
            addLog('üîç Scan des utilisateurs...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                let report = `\nüìä RAPPORT UTILISATEURS\n`;
                report += `Total: ${snapshot.size}\n\n`;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    report += `- ${data.email} (${data.role})\n`;
                });

                alert(report);
                addLog(`‚úÖ Scan termin√©: ${snapshot.size} utilisateurs`, 'success');
            } catch (error) {
                addLog('‚ùå Erreur scan: ' + error.message, 'error');
            }
        };

        // Find orphans
        window.findOrphans = async function() {
            addLog('üîç Recherche comptes orphelins...', 'info');
            try {
                const deletedSnap = await getDocs(collection(db, 'deleted_users'));
                if (deletedSnap.size === 0) {
                    showAlert('‚úÖ Aucun compte orphelin trouv√©', 'success');
                } else {
                    showAlert(`‚ö†Ô∏è ${deletedSnap.size} comptes orphelins trouv√©s (Auth existe, Firestore supprim√©)`, 'warning');
                }
                addLog(`üîç ${deletedSnap.size} comptes orphelins`, 'warning');
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        // Check permissions
        window.checkPermissions = async function() {
            addLog('‚úÖ V√©rification permissions...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                let issues = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.role === 'utilisateur' && !data.permissions) {
                        issues++;
                    }
                });

                if (issues === 0) {
                    showAlert('‚úÖ Toutes les permissions sont correctes', 'success');
                } else {
                    showAlert(`‚ö†Ô∏è ${issues} utilisateurs avec permissions manquantes`, 'warning');
                }
                addLog(`‚úÖ V√©rification termin√©e: ${issues} probl√®mes`, issues > 0 ? 'warning' : 'success');
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        // Test Auth
        window.testAuth = async function() {
            addLog('üîê Test Authentication...', 'info');
            try {
                if (auth.currentUser) {
                    showAlert(`‚úÖ Authentication OK - User: ${auth.currentUser.email}`, 'success');
                    addLog('‚úÖ Authentication fonctionnelle', 'success');
                } else {
                    showAlert('‚ùå Aucun utilisateur connect√©', 'error');
                    addLog('‚ùå Authentication: Non connect√©', 'error');
                }
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        // Test Firestore
        window.testFirestore = async function() {
            addLog('üíæ Test Firestore...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                showAlert(`‚úÖ Firestore OK - ${snapshot.size} documents dans users`, 'success');
                addLog('‚úÖ Firestore fonctionnel', 'success');
            } catch (error) {
                showAlert('‚ùå Erreur Firestore: ' + error.message, 'error');
                addLog('‚ùå Firestore: ' + error.message, 'error');
            }
        };

        // Test Security Rules
        window.testSecurityRules = async function() {
            addLog('üõ°Ô∏è Test Security Rules...', 'info');
            try {
                // Try to read
                await getDocs(collection(db, 'users'));
                addLog('‚úÖ Lecture autoris√©e', 'success');

                // Try to write
                const testDoc = doc(db, 'test', 'security_test');
                await setDoc(testDoc, { test: true, timestamp: new Date() });
                await deleteDoc(testDoc);
                
                showAlert('‚úÖ Security Rules: Lecture et √©criture OK', 'success');
                addLog('‚úÖ Security Rules fonctionnelles', 'success');
            } catch (error) {
                showAlert('‚ö†Ô∏è Security Rules restrictives: ' + error.message, 'warning');
                addLog('‚ö†Ô∏è Security Rules: ' + error.message, 'warning');
            }
        };

        // Test Complete Flow
        window.testCompleteFlow = async function() {
            addLog('üéØ Test flux complet...', 'info');
            await testAuth();
            await new Promise(r => setTimeout(r, 500));
            await testFirestore();
            await new Promise(r => setTimeout(r, 500));
            await testSecurityRules();
            showAlert('‚úÖ Tests complets termin√©s - Voir console', 'success');
        };

        // Export functions
        window.exportUsers = async function() {
            addLog('üì§ Export utilisateurs...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                const blob = new Blob([JSON.stringify(users, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users_export_${new Date().toISOString()}.json`;
                a.click();
                
                showAlert(`‚úÖ ${users.length} utilisateurs export√©s`, 'success');
                addLog(`‚úÖ Export: ${users.length} utilisateurs`, 'success');
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        window.exportCasiers = async function() {
            addLog('üì§ Export casiers...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'casiers'));
                const casiers = [];
                snapshot.forEach(doc => {
                    casiers.push({ id: doc.id, ...doc.data() });
                });

                const blob = new Blob([JSON.stringify(casiers, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `casiers_export_${new Date().toISOString()}.json`;
                a.click();
                
                showAlert(`‚úÖ ${casiers.length} casiers export√©s`, 'success');
                addLog(`‚úÖ Export: ${casiers.length} casiers`, 'success');
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        window.exportAll = async function() {
            addLog('üì§ Export complet...', 'info');
            await exportUsers();
            await new Promise(r => setTimeout(r, 500));
            await exportCasiers();
        };

        // Clean functions
        window.cleanDeletedUsers = async function() {
            const confirm = prompt('üßπ Nettoyer toutes les traces de suppression?\nTapez: NETTOYER');
            if (confirm !== 'NETTOYER') return;

            addLog('üßπ Nettoyage traces...', 'info');
            try {
                const snapshot = await getDocs(collection(db, 'deleted_users'));
                let count = 0;
                for (const docSnap of snapshot.docs) {
                    await deleteDoc(doc(db, 'deleted_users', docSnap.id));
                    count++;
                }
                showAlert(`‚úÖ ${count} traces nettoy√©es`, 'success');
                addLog(`‚úÖ ${count} traces supprim√©es`, 'success');
                loadStats();
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        window.purgeCache = function() {
            addLog('üßπ Purge cache...', 'info');
            localStorage.clear();
            sessionStorage.clear();
            showAlert('‚úÖ Cache purg√© - Rechargez la page', 'success');
            addLog('‚úÖ Cache purg√©', 'success');
        };

        // GitHub
        window.openGitHub = function() {
            const repo = prompt('üêô Entrez l\'URL du repository GitHub:');
            if (repo) {
                window.open(repo, '_blank');
                addLog('üêô Ouverture GitHub', 'info');
            }
        };

        window.checkVersion = function() {
            const version = '1.0.0'; // √Ä mettre √† jour
            alert(`üìå Version: ${version}\nDate: ${new Date().toLocaleDateString('fr-FR')}`);
            addLog(`üìå Version: ${version}`, 'info');
        };

        window.createBackup = function() {
            addLog('üíæ Cr√©ation backup...', 'info');
            showAlert('üíæ Backup local cr√©√© (export JSON)', 'info');
            exportAll();
        };

        // Dev tools
        window.openDevTools = function() {
            addLog('üîß Ouvrez F12 pour DevTools', 'info');
            showAlert('üîß Appuyez sur F12 pour ouvrir DevTools', 'info');
        };

        window.showFirebaseConfig = function() {
            const config = JSON.stringify(firebaseConfig, null, 2);
            alert(`‚öôÔ∏è FIREBASE CONFIG:\n\n${config}`);
            addLog('‚öôÔ∏è Config affich√©e', 'info');
        };

        window.showEnvironment = function() {
            const env = {
                browser: navigator.userAgent,
                url: window.location.href,
                online: navigator.onLine,
                language: navigator.language
            };
            alert(`üåç ENVIRONNEMENT:\n\n${JSON.stringify(env, null, 2)}`);
            addLog('üåç Environment affich√©', 'info');
        };

        // Database
        window.showCollections = async function() {
            addLog('üìö Collections disponibles:', 'info');
            const collections = ['users', 'casiers', 'deleted_users', 'test'];
            alert(`üìö COLLECTIONS FIRESTORE:\n\n${collections.join('\n')}`);
            collections.forEach(col => addLog(`  - ${col}`, 'info'));
        };

        window.countDocuments = async function() {
            addLog('üî¢ Comptage documents...', 'info');
            try {
                const users = await getDocs(collection(db, 'users'));
                const casiers = await getDocs(collection(db, 'casiers'));
                const deleted = await getDocs(collection(db, 'deleted_users'));

                const report = `üìä DOCUMENTS:\n\nusers: ${users.size}\ncasiers: ${casiers.size}\ndeleted_users: ${deleted.size}`;
                alert(report);
                addLog('‚úÖ Comptage termin√©', 'success');
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        // Security
        window.securityAudit = async function() {
            addLog('üîç Audit s√©curit√©...', 'info');
            showAlert('üîç Audit en cours...', 'info');
            
            setTimeout(() => {
                const report = `
üîí AUDIT S√âCURIT√â

‚úÖ Firebase Authentication: OK
‚úÖ Firestore connexion: OK
‚ö†Ô∏è Security Rules: Mode d√©veloppement (ouvert)
‚úÖ HTTPS: ${window.location.protocol === 'https:' ? 'OK' : 'NON (fichier local)'}

RECOMMANDATIONS:
- Activer Security Rules en production
- Utiliser HTTPS en production
- Limiter les permissions des utilisateurs
                `;
                alert(report);
                addLog('‚úÖ Audit termin√©', 'success');
            }, 2000);
        };

        // Repair functions
        window.repairMissingProfiles = async function() {
            addLog('üîß R√©paration profils...', 'info');
            showAlert('üîß Utilisez nettoyage-complet.html pour r√©parer', 'info');
        };

        window.repairAdminProfile = function() {
            window.location.href = 'fix-profile.html';
        };

        // Performance test
        window.performanceTest = async function() {
            addLog('‚ö° Test performance...', 'info');
            const start = performance.now();
            
            try {
                await getDocs(collection(db, 'users'));
                const end = performance.now();
                const time = (end - start).toFixed(2);
                
                showAlert(`‚ö° Performance: ${time}ms`, time < 1000 ? 'success' : 'warning');
                addLog(`‚ö° Temps de r√©ponse: ${time}ms`, time < 1000 ? 'success' : 'warning');
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        window.integrityCheck = async function() {
            addLog('üîç V√©rification int√©grit√©...', 'info');
            await checkPermissions();
            await findOrphans();
            showAlert('‚úÖ V√©rification termin√©e', 'success');
        };

        // Generate report
        window.generateReport = async function() {
            addLog('üìä G√©n√©ration rapport...', 'info');
            
            try {
                const users = await getDocs(collection(db, 'users'));
                const casiers = await getDocs(collection(db, 'casiers'));
                const deleted = await getDocs(collection(db, 'deleted_users'));

                const report = {
                    date: new Date().toISOString(),
                    stats: {
                        users: users.size,
                        casiers: casiers.size,
                        deleted: deleted.size
                    },
                    users: [],
                    casiers: []
                };

                users.forEach(doc => report.users.push({ id: doc.id, ...doc.data() }));
                casiers.forEach(doc => report.casiers.push({ id: doc.id, ...doc.data() }));

                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rapport_complet_${new Date().toISOString()}.json`;
                a.click();

                showAlert('‚úÖ Rapport g√©n√©r√© et t√©l√©charg√©', 'success');
                addLog('‚úÖ Rapport cr√©√©', 'success');
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
            }
        };

        // Clear logs
        window.clearLogs = function() {
            document.getElementById('systemConsole').innerHTML = '<div class="console-line info">‚úÖ Logs effac√©s</div>';
            addLog('‚úÖ Syst√®me pr√™t', 'success');
        };

        // Show logs
        window.showLogs = function() {
            addLog('üìã Tous les logs sont affich√©s dans la console ci-dessous', 'info');
        };

        window.showErrorLogs = function() {
            addLog('‚ùå Fonction en d√©veloppement', 'warning');
        };

        // Init
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('currentUser').textContent = user.email;
                addLog(`‚úÖ Connect√©: ${user.email}`, 'success');
                loadStats();
            } else {
                document.getElementById('currentUser').innerHTML = '<span style="color: #ff6b6b;">Non connect√©</span>';
                addLog('‚ö†Ô∏è Non connect√©', 'warning');
                setTimeout(() => {
                    if (confirm('Vous devez √™tre connect√©. Redirection vers index.html?')) {
                        window.location.href = 'index.html';
                    }
                }, 2000);
            }
        });

        addLog('üöÄ Admin Administrator initialis√©', 'success');
    </script>
</body>
</html>
